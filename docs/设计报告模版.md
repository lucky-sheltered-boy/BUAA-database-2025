以下是根据您提供的PDF截图和OCR内容整理的Markdown文档。

---

# 《数据库系统原理》大作业
## 系统设计报告

**题目名称：** “问卷豆”问卷管理平台

**学号及姓名：**
*   20373087 夏雨阳
*   20373400 欧阳皓东
*   20185614 王默晗

**日期：** 2022 年 12 月 19 日

---

## 组内同学承担任务说明

| 负责学生 | 任务 | 备注 |
| :--- | :--- | :--- |
| **夏雨阳，欧阳皓东** | 子任务 1：系统功能设计与数据库设计 | **夏雨阳：** 数据库逻辑结构设计，关系模式规范化，撰写数据库设计报告<br>**欧阳皓东：** 需求分析（数据流图，数据字典），E-R 图设计 |
| **夏雨阳，欧阳皓东，王默晗** | 子任务 2：系统服务器端开发 | **夏雨阳：** 撰写数据库实现报告<br>**欧阳皓东：** 数据库系统服务器部署<br>**王默晗：** 在后端实现前端的请求接口，管理数据库 |
| **夏雨阳，欧阳皓东** | 子任务 3：系统客户端开发 | **夏雨阳：** 设计并实现问卷系统<br>**欧阳皓东：** 设计并实现团队系统 |

---

## 一. 需求分析

### 1. 需求描述
本项目实现了问卷调查平台。用户可以在此平台上制作问卷，发放问卷，填写问卷，查看结果。

创建问卷时，用户既可以选择从零开始创建，也可以从自己曾经创建的问卷开始，还可以从公共模板创建，这些模板来自于每个用户的贡献；编辑完问卷后，用户可以随时暂停和开始问卷的发放；收到答卷后，网站将提供数据可视化功能，帮助用户更好地分析数据。

此外，网站实现了团队系统（类似于腾讯问卷提供的团队功能），用于管理团队内部的问卷调查，团队问卷只能在团队内可见，具有较高的保密性。团队支持普通成员，管理员，群主三种权限，其中群主可以任命和解除管理员权限，群主和管理员具有接受成员申请，移除团队成员的权限。这可以较好地模拟现实团队的情况。

### 2. 数据流图

#### 2.1 顶层数据流图
从顶层看，用户可以创建，编辑，发布问卷；填写问卷；修改个人信息；管理团队，包括加入团队，管理团队成员，退出团队；预览问卷；查看问卷答卷结果；对问卷系统做出评价。

*（图 1 顶层数据流图）*

#### 2.2 0 层数据流图
问卷管理系统分为用户系统，问卷系统，团队系统三个子系统。其中，用户系统功能包括登陆注册，对问卷平台进行评价，修改个人信息，相对于其他系统独立。问卷系统是整个平台的核心，涵盖了一切与问卷相关的操作。团队系统涵盖了团队相关操作，除此之外，它还会调用问卷系统的接口，使得用户可以创建和管理团队问卷。

*（图 2 0 层数据流图）*

#### 2.3 1 层数据流图
##### 2.3.1.1 用户系统
用户登陆时，前端将账号密码发送到后端，后端如果在用户表中同时匹配到了二者，则将用户表中的 id（可以理解为用户令牌）返回给前端，这一 id 将一直被缓存在前端，直到用户退出登录。用户修改个人信息时，前端向后端发送缓存的用户 id 和修改后的用户信息。用户进行网站评价时，前端将用户 id 和对应的评价发送给后端，后端将其写入评价表中。

*（图 3 用户系统数据流图）*

##### 2.3.1.2 问卷系统
*   **创建问卷：** 如果是通过模板创建，会根据模板信息复制出一份问卷；如果是从自己曾经创建的问卷开始，会复制相应的问卷，否则从零开始。
*   **编辑问卷：** 在前端维护问卷、问题、问题项的数据，点击保存后，将其分别写入数据库的问卷表、问题表、问题项表。
*   **预览问卷：** 从数据库中提取出问卷标题、描述等基本信息，加上问卷的所有问题以及相应的问题项，全部发送给前端进行渲染。
*   **查看结果：** 从数据库中提取出问卷所有内容，同时针对每个问题，还会提取出针对该问题的答题结果，在前端进行可视化。
*   **发布问卷：** 前端将问卷 id 提供给后端，供其修改数据库中的问卷发布状态。
*   **填写问卷：** 同时保存答卷人 id 和答案。

*（图 4 问卷系统数据流图 / 图 5 问卷系统主要功能模块数据流图）*

##### 2.3.1.3 团队系统
问卷平台的用户可以创建团队，也可以申请加入某个团队，该团队的群主或管理员看到申请后可以通过或拒绝申请，通过申请后用户正式成为团队的一员并拥有默认的最低权限。群主可以为团队成员设置或取消管理员权限，群主和管理员都可以踢出成员，审核新成员申请。

创建或填写团队问卷时，团队系统会调用问卷系统的接口，实现了复用。

*（图 6 团队系统数据流图）*

---

### 3. 数据字典

#### （1）数据组名：用户信息
| 数据项名 | id | 用户名 | 密码 | 电话 | 生日 | 自我介绍 | 邮箱余额 | 短信余额 | 账户等级 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | char | char | char | date | varchar | int | int | int |
| 数据宽度 | 32 | 10 | 20 | 14 | 对应date | 1024 | 32 | 32 | 32 |
| 值约束 | 主键 | / | / | 合法电话号码 | YYYY-MM-DD | 默认值是空字符串 | 大于等于0 | 大于等于0 | 大于等于0 |
| 允许空值 | 否 | 否 | 否 | 是 | 是 | 否 | 否 | 否 | 否 |

#### （2）数据组名：问卷信息
| 数据项名 | id | 用户 id | 标题 | 问卷描述 | 创建时间 | 发布状态 | 团队 id |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | int | char | char | datetime | boolean | int |
| 数据宽度 | 32 | 32 | 20 | 255 | 对应datetime | 1 | 32 |
| 值约束 | 主键 | 创建者 id | 默认为空字符串 | 默认为空字符串 | 值为创建时刻 | / | 个人问卷为空，团队问卷为所在团队 |
| 允许空值 | 否 | 否 | 否 | 否 | 否 | 否 | 是 |

#### （3）数据组名：问题信息
| 数据项名 | id | 题干 | 问题种类 | 题号 | 问卷 id |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | char | int1 | int | int |
| 数据宽度 | 32 | 64 | 8 | 32 | 32 |
| 值约束 | 主键 | 默认为空字符串 | 0-单选，1-多选，2-填空 | 大于等于1 | 所在问卷 id |
| 允许空值 | 否 | 否 | 否 | 否 | 否 |

#### （4）数据组名：问题项信息
| 数据项名 | id | 内容 | 题目项序号 | 问题 id |
| :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | char | int | int |
| 数据宽度 | 32 | 64 | 32 | 32 |
| 值约束 | 主键 | 默认为空字符串 | 大于等于 1 | 所在问题 id |
| 允许空值 | 否 | 否 | 否 | 否 |

#### （5）数据组名：问卷模板信息
| 数据项名 | id | 创建者 id | 标题 | 描述 | 创建时间 | 模板引用次数 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | int | char | varchar | datetime | int |
| 数据宽度 | 32 | 32 | 20 | 1024 | 对应datetime | 32 |
| 值约束 | 主键 | 关联用户 | 默认为空字符串 | 默认为空字符串 | 插入记录时刻 | / |
| 允许空值 | 否 | 否 | 否 | 否 | 否 | 否 |

#### （6）数据组名：模板问题
| 数据项名 | id | 模板 id | 内容 | 问题种类 | 题号 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | int | char | int1 | int |
| 数据宽度 | 32 | 32 | 64 | 8 | 32 |
| 值约束 | 主键 | 问题所在模板 | 默认为空字符串 | 0-单选，1-多选，2-填空 | 大于等于 1 |
| 允许空值 | 否 | 否 | 否 | 否 | 否 |

#### （7）数据组名：模板问题项
| 数据项名 | id | 模板问题 id | 内容 | 模板问题项序号 |
| :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | int | char | int |
| 数据宽度 | 32 | 32 | 64 | 32 |
| 值约束 | 主键 | 问题项所在模板问题 | 默认为空字符串 | 大于等于 1 |
| 允许空值 | 否 | 否 | 否 | 否 |

#### （8）数据组名：团队
| 数据项名 | id | 名字 | 创建者 id | 团队标签 | 描述 | 创建时间 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | int | int | char | varchar | datetime |
| 数据宽度 | 32 | 32 | 32 | 255 | 1024 | 对应datetime |
| 值约束 | 主键 | 默认为空字符串 | 关联创建者 | 英文和空格，#隔开 | 默认为空字符串 | 创建团队时刻 |
| 允许空值 | 否 | 否 | 否 | 否 | 否 | 否 |

#### （9）数据组名：意见反馈
| 数据项名 | id | 用户 id | 满意度 | 推荐可能性 | 评价文字 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | int | int | double | varchar |
| 数据宽度 | 32 | 32 | 32 | 64 | 1024 |
| 值约束 | 主键 | 关联用户 | [0,5] | 0-1 之间 | 至少一个字符 |
| 允许空值 | 否 | 否 | 否 | 否 | 否 |

#### （10）数据组名：图片
| 数据项名 | id | 用户 id | 名字 | 图片内容 | 上传时间 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 数据类型 | int | int | char | medianblob | datetime |
| 数据宽度 | 32 | 32 | 255 | 4 M | 对应datetime |
| 值约束 | 主键 | 上传用户 | 至少一个字符 | 二进制流 | 上传时刻 |
| 允许空值 | 否 | 否 | 否 | 否 | 否 |

---

## 二. 数据库概念模式设计

### 1. 系统分 E-R 图
*   一个问卷可以包含多个问题，一个问题可以包含多个问题项。对于选择题，问题项是选项，对于填空题，问题项是每个空对应的小题。模板、模板问题、模板问题项的关系与之类似。
*   用户可以创建多份个人问卷，也可以在多个团队中创建多份问卷，创建的问卷只会属于一个团队。
*   用户可以填写多份问卷，每份问卷可以被多个用户填写。
*   一个用户可以申请加入多个团队，一个团队有多个用户。

*（图 7 分 E-R 图）*

### 2. 系统初步 E-R 图
*（图 8 系统初步 E-R 图）*

### 3. 系统基本 E-R 图
用户，答案，问题是 1:1:1 关系，因此将实体答案下降为“用户回答问题”这一关系的属性，答案的时间属性变为该关系的属性。消除冗余后的基本 E-R 图如下：

*（图 9 系统基本 E-R 图 - 已略去属性，详见分 E-R 图）*

---

## 三. 数据库逻辑模式设计

### 1. 数据库关系模式（由 E-R 图得到）

#### 1.1 实体：
*   **用户**(`id`, 用户名, 密码, 电话, 生日, 自我介绍, 短信余额, 邮箱余额, 账户等级)
*   **问卷**(`id`, 标题, 描述, 用户 id, 团队 id, 创建时间, 发布状态)
*   **问题**(`id`, 题干, 题号, 问题种类, 问卷 id)
*   **题目项**(`id`, 内容, 题目项序号, 题目 id)
*   **模板**(`id`, 标题, 描述, 引用次数, 创建者 id, 创建时间)
*   **模板问题**(`id`, 题干, 题号, 问题种类, 模板 id)
*   **模板问题项**(`id`, 内容, 题目项序号, 模板问题 id)
*   **意见反馈**(`id`, 满意度, 推荐可能性, 评价文字, 用户 id)
*   **团队**(`id`, 团队标签, 描述, 创建时间, 创建者 id)
*   **图片**(`id`, 文件名, 创建时间, 创建者 id, 二进制流)

#### 1.2 联系：
*   **用户-团队-问卷**(`用户 id`, `问卷 id`, `团队 id`)
*   **用户-个人问卷**(`用户 id`, `问卷 id`)
*   **用户-团队**(`用户 id`, `团队 id`)
*   **待审批用户-团队**(`用户 id`, `团队 id`)
*   **问卷-题目**(`问卷 id`, `题目 id`)
*   **题目-题目项**(`题目 id`, `题目项 id`)
*   **用户回答题目**(`用户 id`, `题目 id`, `回答时间`, 答案文本)
*   **模板-模板题目**(`模板 id`, `模板题目 id`)
*   **模板题目-模板题目项**(`模板题目 id`, `模板题目项 id`)
*   **用户贡献模板**(`用户 id`, `模板 id`)
*   **用户提出意见反馈**(`用户 id`, `意见反馈 id`)
*   **用户-图片**(`用户 id`, `图片 id`)
*   **用户-头像**(`用户 id`, `图片 id`)
*   **团队-头像**(`团队 id`, `图片 id`)

### 2. 关系模式范式等级的判定与规范化（规范至 3NF）
*   **1NF：** 所有关系都不存在元组分量表中套表的情况。
*   **实体：** 码为 id，用户还有用户名这一候选码。各实体除了码引入的函数依赖外没有其他函数依赖，所有属性都完全函数依赖于码，且不传递函数依赖。因此所有实体关系至少是 **3NF**。
*   **二元联系：** 只有两个属性，不可能存在部分/传递函数依赖，一定是 **3NF**。
*   **用户回答题目：** 唯一的码为(`用户 id`, `题目 id`, `回答时间`)，唯一的函数依赖为 `(用户 id, 题目 id, 回答时间) -> 答案文本`。因此为 **3NF**。
*   **用户-团队-问卷：** 唯一的码为 `问卷 id`，极小函数依赖集为 `{问卷 id -> 用户 id, 问卷 id -> 团队 id}`，没有部分/传递函数依赖，因此也是 **3NF**。

综上所述，所有实体和联系的关系都至少是 **3NF**。

---

### 3. 数据库设计优化

#### 1. 关系模式的简化
*   **1:n 关系优化：** 问卷-问题、问题-问题项、模板-模板问题、模板问题-模板问题项、用户反馈、用户模板、用户图片均为 1:n 关系。通过在 n 端实体中加入 1 端实体的 id，避免建立单独的联系表。
*   **1:1 关系优化：** 用户-头像和团队-头像均为 1:1 关系，在用户表和团队表中分别加入 `头像 id`。
*   **三元联系优化：** “用户-团队-问卷”中，由于一份团队问卷只能由一个用户创建且属于一个团队，可利用问卷中的 `团队 id` 和 `用户 id` 确定所属，该三元联系被优化掉。
*   **最终保留的 n:m 联系表：** 用户-团队，待审核用户-团队，用户回答题目。

#### 2. 索引的建立
*   **用户名索引：** 用户登录时需根据用户名查找，在 `用户名` 上建立索引。
*   **问卷结构查询：** 获取问卷的所有问题及问题项是高频请求。在 `问题表.问卷 id` 和 `问题项表.问题 id` 上建立索引，利用索引二分查找将复杂度从 $O(m+n)$ 降到 $O(log\ m + k\ log\ n)$。
*   **模板索引：** 类似地，在 `模板问题表.模板 id` 和 `模板问题项表.模板问题 id` 上建立索引。

#### 3. 数据库变量类型选择
*   尽量选用 `char` 而不是 `varchar`（速度更快）。对于用户名、密码、问卷标题等长度不大可能超过 255 的字符串，优先使用 `char` 以空间换时间。

#### 4. 数据库存储过程（procedure）
*   将多条 SQL 操作集成到存储过程中，减少连接次数，并通过事务封装确保 **ACID** 特性（start transaction - commit）。

#### 5. 数据库外模式（视图）
*   为不同接口建立视图，降低查询难度并保证数据安全性。例如：创建 `团队问卷视图`（仅包含团队相关问卷）和 `个人问卷视图`。

#### 6. 避免 null
*   在 DBMS 中 `null` 会引发统计忽视（如 count）和匹配难度。建表时尽量设置 `not null` 约束和默认值：字符串默认为空字符串 `''`，日期字段默认为 `current_timestamp()`。