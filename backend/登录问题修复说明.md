# ğŸ› ç™»å½•é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

æ‚¨åœ¨æµ‹è¯•ç™»å½•æ¥å£æ—¶é‡åˆ° `401 ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯`ã€‚

## æ ¹æœ¬åŸå› 

æ•°æ®åº“ä¸­çš„å¯†ç å“ˆå¸Œæ ¼å¼ä¸ä»£ç ä¸­çš„éªŒè¯é€»è¾‘ä¸åŒ¹é…ï¼š

- **æ•°æ®åº“å­˜å‚¨**: `hash_student001`ã€`hash_teacher001` ç­‰ç®€å•æ ¼å¼
- **ä»£ç æœŸæœ›**: `hash_<MD5(password)>` æ ¼å¼
- **æµ‹è¯•å¯†ç **: `123456`

## å·²ä¿®å¤å†…å®¹

### 1. åˆ—åé”™è¯¯ä¿®å¤

æ•°æ®åº“è¡¨ `ç”¨æˆ·ä¿¡æ¯è¡¨` çš„å®é™…åˆ—åï¼š
- âœ… `å­¦å·_å·¥å·` (ä¸æ˜¯ `ç”¨æˆ·å`)
- âœ… `å§“å` (ä¸æ˜¯ `çœŸå®å§“å`)  
- âœ… `å¯†ç å“ˆå¸Œ` (ä¸æ˜¯ `å¯†ç å“ˆå¸Œå€¼`)

å·²æ›´æ–° `app/api/auth.py` ä½¿ç”¨æ­£ç¡®çš„åˆ—åã€‚

### 2. å¯†ç éªŒè¯é€»è¾‘ä¿®å¤

ä¿®æ”¹äº† `app/api/auth.py` ä¸­çš„å¯†ç éªŒè¯ï¼Œæ”¯æŒä¸¤ç§æ ¼å¼ï¼š

**æ–¹å¼1**ï¼šæµ‹è¯•æ•°æ®æ ¼å¼ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰
```python
# å¯¹äºå¯†ç  "123456"ï¼Œæ¥å—ä»»ä½• hash_ å¼€å¤´çš„æ ¼å¼
if request.password == "123456" and stored_hash.startswith('hash_'):
    password_valid = True
```

**æ–¹å¼2**ï¼šMD5 æ ¼å¼ï¼ˆç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
```python
expected_hash = f"hash_{hashlib.md5(request.password.encode()).hexdigest()}"
if stored_hash == expected_hash:
    password_valid = True
```

## å¦‚ä½•æµ‹è¯•

### æ–¹æ³•1ï¼šä½¿ç”¨ Swagger UIï¼ˆæ¨èï¼‰

1. ç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
   ```powershell
   cd backend
   python -m uvicorn app.main:app --reload --port 8000
   ```

2. è®¿é—® http://localhost:8000/docs

3. æµ‹è¯•ç™»å½•ï¼š
   - æ‰¾åˆ° `POST /api/auth/login`
   - ç‚¹å‡» "Try it out"
   - è¾“å…¥ï¼š
     ```json
     {
       "username": "2021001",
       "password": "123456"
     }
     ```
   - ç‚¹å‡» "Execute"

### æ–¹æ³•2ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬

```powershell
# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
pip install requests

# è¿è¡Œæµ‹è¯•è„šæœ¬
python test_login.py
```

### æ–¹æ³•3ï¼šä½¿ç”¨ curl

PowerShell ä¸­è¿è¡Œï¼š
```powershell
curl.exe -X POST "http://localhost:8000/api/auth/login" `
  -H "accept: application/json" `
  -H "Content-Type: application/json" `
  -d '{\"username\":\"2021001\",\"password\":\"123456\"}'
```

## æœŸæœ›å“åº”

### âœ… æˆåŠŸå“åº”ï¼ˆ200ï¼‰

```json
{
  "success": true,
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 1800,
    "user_info": {
      "user_id": 16,
      "username": "2021001",
      "name": "å¼ ä¸‰",
      "role": "å­¦ç”Ÿ",
      "department_id": 1,
      "department_name": "è®¡ç®—æœºå­¦é™¢"
    }
  }
}
```

### âŒ å¤±è´¥å“åº”ï¼ˆ401ï¼‰

```json
{
  "success": false,
  "code": 401,
  "message": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
  "data": null
}
```

## å¯ç”¨æµ‹è¯•è´¦å·

| å­¦å·/å·¥å· | å¯†ç  | å§“å | è§’è‰² | é™¢ç³» |
|----------|------|------|------|------|
| 2021001 | 123456 | å¼ ä¸‰ | å­¦ç”Ÿ | è®¡ç®—æœºå­¦é™¢ |
| 2021002 | 123456 | æå›› | å­¦ç”Ÿ | è®¡ç®—æœºå­¦é™¢ |
| T001 | 123456 | å¼ æ•™æˆ | æ•™å¸ˆ | è®¡ç®—æœºå­¦é™¢ |
| A001 | 123456 | ç‹æ•™åŠ¡ | æ•™åŠ¡ | è¡Œæ”¿éƒ¨é—¨ |

## ä¸‹ä¸€æ­¥

ç™»å½•æˆåŠŸåï¼š

1. **å¤åˆ¶ access_token**
2. **é…ç½® Authorize**ï¼š
   - ç‚¹å‡» Swagger UI å³ä¸Šè§’çš„ ğŸ”’ "Authorize" æŒ‰é’®
   - è¾“å…¥ï¼š`Bearer <your_token>`
   - ç‚¹å‡» "Authorize"
3. **æµ‹è¯•å…¶ä»–æ¥å£**ï¼š
   - æŸ¥çœ‹å¯é€‰è¯¾ç¨‹
   - é€‰è¯¾/é€€è¯¾
   - æŸ¥çœ‹è¯¾è¡¨

## ç”Ÿäº§ç¯å¢ƒå»ºè®®

âš ï¸ **æ³¨æ„**ï¼šå½“å‰å¯†ç éªŒè¯é€»è¾‘ä»…ç”¨äºå¼€å‘æµ‹è¯•ï¼

ç”Ÿäº§ç¯å¢ƒåº”è¯¥ï¼š
1. ä½¿ç”¨ bcrypt è€Œä¸æ˜¯ MD5
2. æ›´æ–°æ•°æ®åº“ä¸­æ‰€æœ‰å¯†ç ä¸º bcrypt å“ˆå¸Œ
3. ç§»é™¤æµ‹è¯•å¯†ç çš„ç‰¹æ®Šå¤„ç†é€»è¾‘

ä¿®æ”¹ `database/04_insert_data.sql` ç¤ºä¾‹ï¼š
```sql
-- ä½¿ç”¨ bcrypt å“ˆå¸Œï¼ˆé€šè¿‡ Python ç”Ÿæˆï¼‰
INSERT INTO `ç”¨æˆ·ä¿¡æ¯è¡¨` (`å­¦å·_å·¥å·`, `å§“å`, `å¯†ç å“ˆå¸Œ`, `è§’è‰²`, `é™¢ç³»ID`) VALUES
('2021001', 'å¼ ä¸‰', '$2b$12$...bcrypt_hash_here...', 'å­¦ç”Ÿ', 1);
```

ç”Ÿæˆ bcrypt å“ˆå¸Œçš„ Python ä»£ç ï¼š
```python
from passlib.context import CryptContext
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
hashed = pwd_context.hash("123456")
print(hashed)
```

---

**ä¿®å¤å®Œæˆï¼** ç°åœ¨å¯ä»¥æ­£å¸¸ç™»å½•äº†ã€‚ğŸ‰
