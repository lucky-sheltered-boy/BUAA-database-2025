# 当前网站存在的问题

## 已修复问题
### 1. 学生端课表地点显示缺失
**问题描述**：
- 在学生端“我的课表”页面，下方的课表网格中，课程块只显示课程名称，未显示上课地点。

**修复方案**：
- 修改了 `frontend/src/views/student/MySchedule.vue` 的模板。
- 将原本引用的不存在的 `.location` 属性改为直接引用 `.building` 和 `.room` 属性。
- 确保了课表网格中能正确显示“教学楼+房间号”。

### 2. 教师端课表显示缺失
**问题描述**：
- 在教师端“我的课表”界面，课程列表显示正常，但下方的课表网格（Grid View）为空，不显示任何课程。

**修复方案**：
- 修改了 `frontend/src/views/teacher/MySchedule.vue` 中的 `getCourseAt` 函数。
- 实现了从“星期+节次”到“具体课程”的映射逻辑：
    - 将前端的 13 节课映射到数据库定义的 5 个时间段（如第1-2节对应 08:00:00）。
    - 修正了星期索引的处理（将星期日的索引 0 转换为 7，以匹配循环逻辑）。
    - 实现了基于 `start_time` 的课程查找。

### 3. 教师端“我的课表”选课人数统计错误
**问题描述**：
- 在教师端“我的课表”页面，课程卡片上显示的选课人数与实际学生名单人数不符（例如显示4人，实际只有2人）。
- 原因：数据库初始化脚本 `04_insert_data.sql` 中手动设置了初始选课人数，而后续插入选课记录时触发器再次累加，导致人数重复计算。

**修复方案**：
- 修正了 `database/04_insert_data.sql`，将所有开课实例的初始 `已选对内人数` 和 `已选对外人数` 设为 0。
- 执行了数据修复脚本，重置并重新计算了当前数据库中所有课程的选课人数，确保与 `选课记录表` 保持一致。

### 4. 学生端选课中心时间段显示错误
**问题描述**：
- 在学生端选课中心页面，可选课程的时间段显示为“周undefined 第3节”。
- 用户希望显示具体时间段（如“周二 14:00:00-15:40:00”），与“我的课表”保持一致。

**修复方案**：
- 后端：
    - 修改 `backend/app/api/students.py`，在查询可选课程的时间段信息时，增加了 `start_time` 和 `end_time` 字段的查询和返回。
- 前端：
    - 修改 `frontend/src/views/student/CourseSelection.vue` 中的 `formatTimeSlot` 函数。
    - 增加了对 `start_time` 和 `end_time` 的支持，优先显示具体时间段。
    - 修复了星期显示可能为 undefined 的问题（通过 `parseInt` 确保类型正确）。

### 5. 教师端概览统计错误
**问题描述**：
- 在开课程统计错误：将同一课程的不同时间段实例重复统计。
- 学生总数统计错误：重复累加同一课程实例的选课人数（例如一周两节课会导致人数翻倍）。
- 课程列表显示重复。

**修复方案**：
- 修改了 `frontend/src/views/teacher/Dashboard.vue` 中的 `fetchStats` 方法。
- 增加了数据预处理逻辑：
    1.  先根据 `instance_id` 对后端返回的课表数据进行去重，确保每个开课实例只计算一次。
    2.  基于去重后的数据统计课程总数（按 `course_id` 去重）和学生总数。
    3.  课程列表按 `course_id` 聚合展示，合并同一课程的选课人数。

### 6. 新增课程“隐身”及创建失败
**问题描述**：
- 在教务端新增课程实例后，学生端和教师端均无法看到该课程。
- 原因：后端计算“时间段ID”的公式 `(weekday - 1) * 5 + time_slot` 存在缺陷，当选择非连续时间段（如周末或第6节课以后）时，计算出的ID在数据库中不存在，导致 `sp_add_schedule_time` 存储过程执行失败。
- 由于事务回滚，虽然日志显示“创建实例成功”，但实际上数据并未保存。

**修复方案**：
- 修改了 `backend/app/api/admin.py` 中的 `create_instance` 接口。
    - 废弃了硬编码的ID计算公式。
    - 改为直接查询数据库 `时间段信息表`，根据星期和节次动态获取正确的 `时间段ID`。
    - 增加了校验逻辑：如果管理员选择了数据库中未配置的时间段（如周六或第6节课），系统将直接抛出明确的错误提示（例如“星期六没有配置第1节课的时间段”），而不是静默失败。
- 更新了数据库存储过程 `sp_add_schedule_time`。
    - 优化了错误处理机制，使用 `GET DIAGNOSTICS` 捕获并返回具体的数据库错误信息，便于排查问题。

## 待办事项
- [ ] 考虑在数据库中补充周末或晚间（第6节以后）的时间段数据，以支持更多排课需求。