以下是根据您提供的PDF截图和OCR内容整理的Markdown文档：

---

# 《数据库系统原理》大作业
## 系统实现报告

**题目名称：** “问卷豆”问卷管理平台
**学号及姓名：**
*   20373087 夏雨阳
*   20373400 欧阳皓东
*   20185614 王默晗

**日期：** 2022 年 12 月 23 日

---

## 一. 系统结构设计（包括体系结构和功能结构）

### 1.1 体系结构
采用前端、后端、数据库分离的体系结构。数据库存储、管理数据；后端将数据库数据传送给前端、接收前端请求并且传递给数据库，调用数据库存储过程或者直接执行 SQL 命令；前端与用户交互，显示数据库数据并且接收用户修改数据的请求。

#### 1.1.1 前端
*   **框架：** vue3 + element-ui。vue 具有良好的封装性和模块化，组件间传参便捷，有利于代码复用。
*   **脚本语言：** ES6 标准的 JavaScript（未采用 typescript 以避免与 element-ui 的兼容性问题）。

#### 1.1.2 后端
*   **框架：** django (Python)。代码抽象程度高，适合小型网站后端开发。

#### 1.1.3 前后端通信
*   **工具：** axios。前端发送 json 格式请求，后端通过 urls 路由匹配并分配接口，返回 HttpResponse 或 JsonResponse。前端利用 Promise 对象的 `.then` 和 `.catch` 处理响应和异常。

#### 1.1.4 数据库
*   **系统：** MySQL 8.0.30。支持 Json 字符串处理功能，便于在存储过程中进行部分数据处理。

**系统体系结构图：**
*(图中显示了 JavaScript/HTML & CSS/Vue -> Axios -> Django -> pymysql/callproc() -> MySQL 的流程)*

### 1.2 功能结构
1.  **用户系统：** 登录注册、修改个人信息、上传头像、填写网站评价反馈。
2.  **问卷系统：** 创建（零创建/模板创建/复制创建）、编辑（单选/多选/填空）、预览（问卷/模板）、发布/停止、查看可用问卷、填写问卷、查看答卷情况（统计图可视化/答案列表）、贡献模板。
3.  **团队系统：** 权限分为群主、管理员、普通成员。功能包括创建/加入/退出/解散团队、踢出成员、授予/取消管理员权限、审核申请、修改团队信息、上传团队头像、创建及填写团队问卷。

---

## 二. 数据库建表语句

### （1）用户表
记录用户名、密码、真实姓名、手机、生日、自我介绍、头像 id、账户等级、余额等。`id` 和 `user_name` 是候选码。

```sql
create table user (
    id int primary key auto_increment,
    user_name char(10) unique not null,
    password char(10) not null,
    real_name char(10) default 'xxx',
    telephone char(14) default '12345678901',
    birthday date default '2022-01-11',
    introduction varchar(8192) default '',
    avatar_image_id int,
    account_level int default 0,
    sms_balance int default 0,
    email_balance int default 0
);
```

### （2）问卷表
```sql
create table questionnaire (
    id int primary key auto_increment,
    user_id int not null,
    title char(255) default '',
    preface varchar(8192) not null,
    create_time datetime default current_timestamp,
    release tinyint(1) default 0,
    team_id int,
    foreign key(user_id) references user(id),
    foreign key(team_id) references team(id)
);
```

### （3）问题表
```sql
create table question (
    id int primary key auto_increment,
    stem char(255) default '' comment '题干文字描述',
    type int not null comment '0-单选题, 1-多选题, 2-填空题',
    rank int not null comment '在问卷中的序号, 从1开始',
    questionnaire_id int not null,
    image_id int,
    foreign key(questionnaire_id) references questionnaire(id),
    foreign key(image_id) references image(id)
);
```

### （4）问题项表
```sql
create table question_item (
    id int primary key auto_increment,
    stem char(255) default '',
    rank int not null,
    question_id int not null,
    foreign key(question_id) references question(id)
);
```

### （5-7）模板相关表
*   **模板表 (`template`)：** 包含 `reference_cnt` 字段统计引用次数。
*   **模板问题表 (`template_question`)** 与 **模板问题项表 (`template_question_item`)** 结构类似于问卷相关表。

### （8）团队表
```sql
create table team (
    id int primary key auto_increment,
    name char(64) not null,
    founder_id int not null,
    region char(64) not null,
    type char(255) not null,
    avatar_image_id int,
    introduction varchar(8192) not null default '',
    create_time datetime default current_timestamp,
    foreign key(founder_id) references user(id)
);
```

### （10）图片表与外键约束
由于 `user` 表与 `image` 表存在循环依赖，需在建表后增加约束：
```sql
alter table user add constraint foreign key(avatar_image_id) references image(id);
```

### （11-13）关系表
*   **用户回答问题表 (`user_answer_question`)：** 存储用户提交的答案内容及时间。
*   **团队-成员表 (`team_member`)：** 记录成员权限（Founder, Admin, User）。
*   **团队-待审核用户表 (`team_applicant`)。**

---

## 三. 系统重要功能实现方法

### 3.1 触发器设计
为保证删除约束，引入两个触发器：
*   删除问卷前，递归删除其所属的所有问题。
*   删除问题前，递归删除其所属的所有问题项。

### 3.2 存储过程设计

#### 3.2.1 `save_form`
用于保存编辑后的问卷。流程：更新问卷标题/序言 -> 删除原有的所有问题及问题项 -> 遍历输入的问题数组重新插入数据。

#### 3.2.3 `get_form`
获取问卷完整信息（标题、序言、问题、选项）。实现：先查问卷表 -> 结果存入 json -> 查问题表存入临时表 `tq` -> 遍历 `tq` 查选项表 -> 组合成最终 json。

#### 3.2.4 `get_form_answer`
获取答卷统计。针对选择题，利用 `ids` 临时表枚举位置，结合 `substring()` 函数拆分多选题答案字符串，配合 `group by` 和 `count(*)` 统计各选项频数。使用 `ifnull(cnt, 0)` 处理无人选择的选项。

#### 3.2.12-13 头像保存
*   `save_user_avatar`: 保存图片并更新 `user` 表的 `avatar_image_id`。
*   `save_team_avatar`: 保存图片并更新 `team` 表的 `avatar_image_id`。

#### 3.2.29 `dismiss_team` (解散团队)
删除顺序：用户回答记录 -> 团队问卷 -> 团队成员 -> 待审核成员 -> 团队表。该顺序保证了外键约束不被破坏。

---

## 四. 系统实现结果

报告展示了以下页面的 UI 截图：
*   注册/登录页面、用户中心（支持头像上传、账户余额查看）。
*   问卷主页：展示问卷列表，支持编辑、预览、发布/停止、分析、删除。
*   编辑页面：支持动态增加题目和选项，支持题型切换。
*   数据分析页：利用 **echarts** 实现选择题饼图可视化，填空题展示答案列表。
*   问卷填写页：带进度条提示。
*   团队管理：创建团队、成员审核、权限任命（Admin/User）、踢出成员（将问卷所有权转交给群主）。

---

## 五. 总结

1.  **开发历程：** 从 9 月开始选题，通过民主投票确定“问卷管理系统”。中期完成基础页面，后期引入 **MySQL 存储过程** 优化性能。
2.  **技术难点：** 
    *   **图片存储：** 尝试过图床、服务器存储等方案，最终因审核或环境限制选择了将图片二进制流存储在数据库中（MySQL 暴力存图）。
    *   **SQL 功底：** 放弃了 Django 的增删改查，直接手写 SQL 存储过程并封装事务（start transaction - commit），大幅提升了 SQL 实战能力，学会了手搓 JSON 字符串数组。
3.  **收获：** 掌握了前后端分离开发流程，强化了复杂 SQL（连表、exists、临时表、tricks）的使用，提升了团队分工协作与抗压能力。

---
*注：报告完成于 2022 年 12 月 23 日考完最后一科后的周五晚上。*