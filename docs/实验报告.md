# 《数据库系统原理》大作业
## 系统实现报告

**题目名称：** 高校智能排课选课管理系统
**小组成员：**
*   赵骥远
*   朱城宇

**日期：** 2024 年 12 月

---

## 一. 系统结构设计

### 1.1 体系结构
本系统采用经典的前后端分离架构。前端负责页面展示与用户交互，后端负责业务逻辑处理与 API 接口提供，数据库负责数据的持久化存储与核心约束校验。

#### 1.1.1 前端
*   **框架：** Vue 3 + Element Plus。Vue 3 的 Composition API 提供了更好的逻辑复用能力，Element Plus 提供了丰富的 UI 组件，加快开发效率。
*   **状态管理：** Pinia。用于管理用户登录状态（Auth Store）和当前学期信息（Semester Store）。
*   **路由管理：** Vue Router。实现单页应用（SPA）的页面跳转与权限控制（路由守卫）。
*   **通信库：** Axios。封装了请求拦截器和响应拦截器，统一处理 Token 认证和错误提示。

#### 1.1.2 后端
*   **框架：** FastAPI (Python)。高性能的异步 Web 框架，自动生成 OpenAPI 文档（Swagger UI），便于前后端联调。
*   **数据验证：** Pydantic。用于请求参数和响应数据的序列化与验证，确保数据类型安全。
*   **数据库驱动：** PyMySQL / mysql-connector。通过连接池管理数据库连接。

#### 1.1.3 数据库
*   **系统：** MySQL 8.0。
*   **核心特性：** 大量使用 **触发器（Triggers）** 进行复杂的数据完整性校验（如选课冲突检测），使用 **存储过程（Procedures）** 封装原子性的业务操作（如添加教室、开课）。

**系统体系结构图：**
Vue 3 Client (Browser) <--> Axios (JSON/HTTP) <--> FastAPI Server <--> PyMySQL Cursor <--> MySQL Database

### 1.2 功能结构
1.  **用户系统：**
    *   **多角色登录：** 支持学生、教师、教务管理员三种角色登录，采用赛博朋克风格的登录界面。
    *   **个人中心：** 修改密码、查看个人信息。
2.  **教务管理系统（管理员）：**
    *   **基础数据管理：** 院系、教室、时间段、学期、课程的增删改查。
    *   **排课管理：** 创建开课实例（指定课程、教室、学期、名额），安排上课时间（指定时间段、周次、单双周、教师）。
    *   **数据统计：** 查看各院系选课情况统计。
3.  **学生选课系统（学生）：**
    *   **选课中心：** 查看当前学期可选课程，实时显示剩余名额（区分本院/外院），一键选课/退课。
    *   **我的课表：** 网格化展示每周课程，支持按周次切换查看。
4.  **教师教学系统（教师）：**
    *   **我的课表：** 查看授课时间表。
    *   **学生名单：** 查看所授课程的选课学生名单。

---

## 二. 数据库建表语句

### （1）用户信息表
统一存储所有角色的基本信息，通过 `角色` 字段区分。
```sql
CREATE TABLE `用户信息表` (
  `用户ID` INT(11) NOT NULL AUTO_INCREMENT,
  `学号_工号` VARCHAR(20) NOT NULL,
  `姓名` VARCHAR(50) NOT NULL,
  `密码哈希` VARCHAR(255) NOT NULL,
  `角色` ENUM('学生','教师','教务') NOT NULL,
  `院系ID` INT(11) NOT NULL,
  PRIMARY KEY (`用户ID`),
  UNIQUE KEY `uk_学号_工号` (`学号_工号`),
  FOREIGN KEY (`院系ID`) REFERENCES `院系信息表` (`院系ID`)
);
```

### （2）开课实例表
连接课程、教室与学期，是排课的核心实体。
```sql
CREATE TABLE `开课实例表` (
  `开课实例ID` INT(11) NOT NULL AUTO_INCREMENT,
  `课程ID` VARCHAR(20) NOT NULL,
  `教室ID` INT(11) NOT NULL,
  `学期ID` INT(11) NOT NULL,
  `对内名额` INT(11) NOT NULL,
  `对外名额` INT(11) NOT NULL,
  `已选对内人数` INT(11) NOT NULL DEFAULT 0,
  `已选对外人数` INT(11) NOT NULL DEFAULT 0,
  PRIMARY KEY (`开课实例ID`),
  FOREIGN KEY (`课程ID`) REFERENCES `课程信息表` (`课程ID`),
  FOREIGN KEY (`教室ID`) REFERENCES `教室信息表` (`教室ID`),
  FOREIGN KEY (`学期ID`) REFERENCES `学期信息表` (`学期ID`)
);
```

### （3）上课时间表
支持一门课在多个时间段上课，且支持单双周和周次范围。
```sql
CREATE TABLE `上课时间表` (
  `上课时间ID` INT(11) NOT NULL AUTO_INCREMENT,
  `开课实例ID` INT(11) NOT NULL,
  `时间段ID` INT(11) NOT NULL,
  `教师ID` INT(11) DEFAULT NULL,
  `起始周` INT(11) NOT NULL DEFAULT 1,
  `结束周` INT(11) NOT NULL DEFAULT 16,
  `单双周` ENUM('全部','单周','双周') NOT NULL DEFAULT '全部',
  PRIMARY KEY (`上课时间ID`),
  FOREIGN KEY (`开课实例ID`) REFERENCES `开课实例表` (`开课实例ID`),
  FOREIGN KEY (`时间段ID`) REFERENCES `时间段信息表` (`时间段ID`)
);
```

### （4）选课记录表
```sql
CREATE TABLE `选课记录表` (
  `学生ID` INT(11) NOT NULL,
  `开课实例ID` INT(11) NOT NULL,
  `选课时间` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`学生ID`, `开课实例ID`),
  FOREIGN KEY (`学生ID`) REFERENCES `用户信息表` (`用户ID`),
  FOREIGN KEY (`开课实例ID`) REFERENCES `开课实例表` (`开课实例ID`)
);
```

---

## 三. 存储过程实现

### 3.1 添加教室 (sp_add_classroom)
封装了参数校验（非空、容量合法性）和重复性检查，确保数据质量。

```sql
CREATE PROCEDURE `sp_add_classroom`(
    IN p_教学楼 VARCHAR(50),
    IN p_房间号 VARCHAR(20),
    IN p_容量 INT,
    OUT p_教室ID INT,
    OUT p_message VARCHAR(255)
)
BEGIN
    -- 异常处理与回滚
    DECLARE EXIT HANDLER FOR SQLEXCEPTION ...
    START TRANSACTION;
    
    -- 1. 参数验证
    IF p_容量 <= 0 THEN ... END IF;
    
    -- 2. 查重
    IF EXISTS (SELECT 1 FROM `教室信息表` WHERE `教学楼`=p_教学楼 AND `房间号`=p_房间号) THEN ... END IF;
    
    -- 3. 插入
    INSERT INTO `教室信息表` ...;
    COMMIT;
END
```

---

## 四. 触发器实现

### 4.1 选课前检查 (trg_before_enroll_check)
这是系统最核心的逻辑，实现了**数据库层面的强一致性校验**。在插入选课记录前，自动检查：
1.  **名额限制**：区分本院系学生和外院系学生，分别检查对应的剩余名额。
2.  **时间窗口**：检查当前时间是否在学期规定的选课时间内。
3.  **重复选课**：防止同一学生重复选择同一门课。
4.  **时间冲突**：检测新选课程的上课时间是否与已选课程冲突（精确到周次和单双周）。

```sql
CREATE TRIGGER `trg_before_enroll_check`
BEFORE INSERT ON `选课记录表`
FOR EACH ROW
BEGIN
    -- ... 变量声明 ...
    
    -- 1. 获取课程信息与名额
    SELECT ... INTO ... FROM `开课实例表` ...;
    
    -- 2. 检查名额
    IF v_是否本院系 THEN
        IF v_已选对内人数 >= v_对内名额 THEN SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '本院系名额已满'; END IF;
    ELSE
        IF v_已选对外人数 >= v_对外名额 THEN SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '跨院系名额已满'; END IF;
    END IF;
    
    -- 3. 检查时间冲突 (核心逻辑)
    SELECT COUNT(*) INTO v_冲突数
    FROM `选课记录表` sc
    JOIN `上课时间表` t1 ON sc.`开课实例ID` = t1.`开课实例ID`
    JOIN `上课时间表` t2 ON t2.`开课实例ID` = NEW.`开课实例ID`
    WHERE sc.`学生ID` = NEW.`学生ID`
      AND t1.`时间段ID` = t2.`时间段ID` -- 同一时间段
      AND (t1.`起始周` <= t2.`结束周` AND t1.`结束周` >= t2.`起始周`) -- 周次有交集
      AND (t1.`单双周` = '全部' OR t2.`单双周` = '全部' OR t1.`单双周` = t2.`单双周`); -- 单双周冲突
      
    IF v_冲突数 > 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '选课失败: 上课时间冲突';
    END IF;
END
```

---

## 五. 后端实现

### 5.1 接口设计
后端采用 RESTful 风格设计 API。
*   `POST /api/auth/login`: 用户登录，返回 JWT Token。
*   `GET /api/student/courses/available`: 获取可选课程列表（调用视图）。
*   `POST /api/student/enroll`: 学生选课（捕获数据库触发器抛出的异常并返回给前端）。
*   `GET /api/common/schedule`: 获取个人课表。

### 5.2 数据库交互
使用 `cursor.execute()` 执行原生 SQL 或调用存储过程。
```python
# 示例：调用选课存储过程或直接插入
try:
    cursor.execute(
        "INSERT INTO 选课记录表 (学生ID, 开课实例ID) VALUES (%s, %s)",
        (student_id, instance_id)
    )
    connection.commit()
except Exception as e:
    connection.rollback()
    # 解析 MySQL 错误消息（如触发器抛出的“名额已满”）
    raise HTTPException(status_code=400, detail=str(e))
```

---

## 六. 前端实现

### 6.1 界面风格
*   **登录页**：使用了 CSS 动画和霓虹灯效果，打造赛博朋克风格。
*   **仪表盘**：使用了北航校园图片作为背景，配合半透明卡片设计，体现校园特色。

### 6.2 核心组件
*   **CourseCard.vue**：展示课程信息，根据 `对内剩余名额` 和 `对外剩余名额` 动态显示“可选”或“已满”状态。
*   **MySchedule.vue**：使用 CSS Grid 布局绘制课表，根据课程的 `星期` 和 `节次` 自动定位课程卡片。

### 6.3 交互逻辑
前端通过 Axios 拦截器统一处理 401 未授权错误，自动跳转登录页。在选课时，前端会捕获后端返回的错误信息（如“时间冲突”），并通过 Element Plus 的 `ElMessage` 弹窗提示用户。

---

## 七. 总结
本项目成功实现了一个功能完备的高校智能排课选课管理系统。
1.  **数据库设计扎实**：充分利用了 MySQL 的触发器和存储过程，将核心业务逻辑（如冲突检测、名额控制）下沉到数据库层，保证了数据的一致性和完整性。
2.  **前后端分离**：架构清晰，分工明确，易于维护和扩展。
3.  **用户体验良好**：界面美观，操作流畅，反馈及时。

通过本次大作业，我们深入理解了数据库系统原理，掌握了数据库应用开发的完整流程。
