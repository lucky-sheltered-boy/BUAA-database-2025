# 高校智能排课选课管理系统 - 使用指南

## 🎓 项目概述

**项目名称**: 高校智能排课选课管理系统  
**开发状态**: ✅ 核心功能已完成，可用于阶段展示  
**数据库类型**: MySQL 8.0 / 华为云 GaussDB  
**最后更新**: 2025-02-28  

### 核心特性
- ✅ **智能冲突检测**: 教师/学生时间冲突、教室冲突、名额限制自动检测
- ✅ **周次灵活管理**: 支持全学期、前/后8周、单周/双周等多种排课模式
- ✅ **跨院系选课**: 自动区分对内/对外名额，支持院系间课程共享
- ✅ **自动化管理**: 14个存储过程封装常用操作，11个触发器保证数据一致性
- ✅ **三层视图**: 当前学期开课、学生课表、教师课表视图简化查询

### 当前进度
- ✅ 数据库设计完成（10张表 + 3个视图）
- ✅ 触发器开发完成（11个，已优化）
- ✅ 存储过程开发完成（14个）
- ✅ 测试数据准备完成（13门课程，28条选课记录）
- ✅ 云端部署测试通过
- ⚠️ 前端开发待启动（可使用SQL脚本演示功能）

---

## 📁 文件说明

```
database/
├── 00_clear_data.sql      # 🆕 快速清理数据脚本(保留结构)
├── 00_rebuild.sql         # 完全重建脚本(删除所有对象)
├── 00_deploy_all.sql      # 一键部署脚本(自动执行01-04)
├── 00_fix_report.md       # 问题修复报告
├── 01_create_table.sql    # 创建表结构(10张表+3个视图)
├── 02_triggers.sql        # 创建触发器(11个，已优化)
├── 03_procedures.sql      # 创建存储过程(14个)
├── 04_insert_data.sql     # 🆕 插入测试数据(简化为13门课程)
├── 05_queries.sql         # 🆕 查询示例(30+个，已更新)
└── 06_test_cases.sql      # 🆕 功能测试用例(31个，已更新)
```

**🆕 = 最近更新的文件**

---

## 🚀 快速开始（阶段展示推荐流程）

### 📋 展示前准备（首次部署）

```sql
-- 方式1: 一键部署(推荐)
SOURCE /path/to/00_deploy_all.sql;   -- 自动执行01-04，3分钟完成

-- 方式2: 手动部署(推荐用于演示讲解)
SOURCE /path/to/01_create_table.sql;   -- ①创建10张表+3个视图
SOURCE /path/to/02_triggers.sql;       -- ②创建11个触发器
SOURCE /path/to/03_procedures.sql;     -- ③创建14个存储过程
SOURCE /path/to/04_insert_data.sql;    -- ④插入测试数据(13门课程)
```

### 🔄 数据重置（调试时使用）

```sql
-- 只清理数据，保留表结构和触发器(推荐，快速)
SOURCE /path/to/00_clear_data.sql;     -- 10秒完成
SOURCE /path/to/04_insert_data.sql;    -- 重新插入数据

-- 完全重建(慎用)
SOURCE /path/to/00_rebuild.sql;        -- 删除所有对象
SOURCE /path/to/00_deploy_all.sql;     -- 重新部署
```

### ✅ 验证部署成功

```sql
-- 检查对象数量
SELECT 
    (SELECT COUNT(*) FROM information_schema.TABLES 
     WHERE TABLE_SCHEMA = DATABASE() AND TABLE_TYPE = 'BASE TABLE') AS '表数量(应为10)',
    (SELECT COUNT(*) FROM information_schema.TABLES 
     WHERE TABLE_SCHEMA = DATABASE() AND TABLE_TYPE = 'VIEW') AS '视图数量(应为3)',
    (SELECT COUNT(*) FROM information_schema.TRIGGERS 
     WHERE TRIGGER_SCHEMA = DATABASE()) AS '触发器数量(应为11)',
    (SELECT COUNT(*) FROM information_schema.ROUTINES 
     WHERE ROUTINE_SCHEMA = DATABASE() AND ROUTINE_TYPE = 'PROCEDURE') AS '存储过程数量(应为14)';

-- 检查测试数据
SELECT '院系' AS 类型, COUNT(*) AS 数量, '预期5' AS 预期 FROM `院系信息表`
UNION ALL SELECT '教室', COUNT(*), '预期13' FROM `教室信息表`
UNION ALL SELECT '课程', COUNT(*), '预期19' FROM `课程信息表`
UNION ALL SELECT '用户', COUNT(*), '预期39' FROM `用户信息表`
UNION ALL SELECT '开课实例', COUNT(*), '预期13' FROM `开课实例表`
UNION ALL SELECT '选课记录', COUNT(*), '预期28' FROM `选课记录表`;
```

---

## 🎬 阶段展示演示脚本

### 演示1: 智能冲突检测（触发器功能）

```sql
-- 场景1: 尝试选择时间冲突的课程(应该被拦截)
-- 张三(ID=16)已选数据结构(周一1-2,周三1-2)
-- 尝试选网络安全(周一1-2,周三3-4)，会检测到周一1-2冲突
CALL sp_student_enroll(16, 10, @msg);
SELECT @msg;  -- 预期: "选课失败: 上课时间冲突"

-- 场景2: 尝试超额选课(应该被拦截)
-- 先查看密码学名额: 对内25，对外5，容量30
SELECT * FROM `开课实例表` WHERE `开课实例ID` = 9;
-- 当名额满后再尝试选课会被拦截
-- 预期: "选课失败: 本院系名额已满" 或 "跨院系名额已满"

-- 场景3: 教室容量自动检测
-- 尝试创建总名额超过教室容量的开课实例
CALL sp_create_course_instance('CS101', 1, 4, 50, 20, @id, @msg);
-- 教室1容量60，总名额70，触发器拦截
SELECT @msg;  -- 预期: "开课失败: 总名额超过教室容量"
```

### 演示2: 周次管理（创新特性）

```sql
-- 展示不同周次安排的课程
SELECT 
    c.`课程名称`,
    CONCAT('第', t.`起始周`, '-', t.`结束周`, '周 ', t.`单双周`) AS '周次安排',
    ts.`星期`,
    CONCAT(ts.`开始时间`, '-', ts.`结束时间`) AS '时间',
    CASE 
        WHEN t.`起始周` = 1 AND t.`结束周` = 16 AND t.`单双周` = '全部' THEN '全学期课程'
        WHEN t.`结束周` = 8 THEN '前半学期课程'
        WHEN t.`起始周` = 9 THEN '后半学期课程'
        WHEN t.`单双周` = '单周' THEN '单周实验课'
        WHEN t.`单双周` = '双周' THEN '双周实验课'
        ELSE '其他安排'
    END AS '课程类型'
FROM `上课时间表` t
JOIN `开课实例表` oi ON t.`开课实例ID` = oi.`开课实例ID`
JOIN `课程信息表` c ON oi.`课程ID` = c.`课程ID`
JOIN `时间段信息表` ts ON t.`时间段ID` = ts.`时间段ID`
ORDER BY `课程类型`, c.`课程名称`;

-- 说明: 
-- ✓ 计算机组成原理: 前8周理论课 + 后8周实验课
-- ✓ 数据库系统: 全学期理论课 + 单周实验课
-- ✓ 大学物理实验: 双周实验课
```

### 演示3: 跨院系选课

```sql
-- 展示跨院系选课情况
SELECT 
    u.`姓名` AS '学生',
    d1.`院系名称` AS '学生院系',
    c.`课程名称`,
    d2.`院系名称` AS '课程院系',
    CASE 
        WHEN d1.`院系ID` = d2.`院系ID` THEN '✓ 本院选课'
        ELSE '★ 跨院选课'
    END AS '选课类型',
    sc.`选课时间`
FROM `选课记录表` sc
JOIN `用户信息表` u ON sc.`学生ID` = u.`用户ID`
JOIN `院系信息表` d1 ON u.`院系ID` = d1.`院系ID`
JOIN `开课实例表` oi ON sc.`开课实例ID` = oi.`开课实例ID`
JOIN `课程信息表` c ON oi.`课程ID` = c.`课程ID`
JOIN `院系信息表` d2 ON c.`院系ID` = d2.`院系ID`
ORDER BY `选课类型` DESC, u.`姓名`;

-- 说明: 
-- ✓ 李四(计算机学院)选修线性代数(数学学院) - 跨院选课
-- ✓ 郑一(软件学院)选修数据结构(计算机学院) - 跨院选课
```

### 演示4: 存储过程使用

```sql
-- 4.1 查询学生完整课表
CALL sp_get_student_schedule(16, 4);  -- 张三在2024-2025春季学期的课表

-- 4.2 查询教师授课情况
CALL sp_get_teacher_schedule(3, 4);   -- 张教授的授课课表

-- 4.3 查询可选课程
CALL sp_get_available_courses(16);    -- 张三可以选择的课程列表

-- 4.4 选课统计
CALL sp_get_enrollment_statistics(4); -- 2024-2025春季学期选课统计
```

### 演示5: 视图简化查询

```sql
-- 5.1 当前学期开课情况
SELECT * FROM `当前学期开课视图`
ORDER BY `课程ID`;

-- 5.2 学生课表视图
SELECT * FROM `学生课表视图`
WHERE `学号` = '2021001'  -- 张三
ORDER BY `星期`, `开始时间`;

-- 5.3 教师课表视图
SELECT * FROM `教师课表视图`
WHERE `教师姓名` = '张教授'
ORDER BY `星期`, `开始时间`;
```

---

## 📊 测试数据说明

### 当前数据规模（简化版，确保无冲突）
- **5个院系**: 计算机、软件、信息安全、数学、物理
- **13个教室**: 容量30-120人，分布在3栋楼
- **19门课程**: 覆盖4个院系的专业课和基础课
- **13个开课实例**: 2024-2025春季学期实际开课（简化后）
- **39个用户**: 2名教务、15名教师、24名学生
- **28条选课记录**: 含本院和跨院选课案例

### 简化说明
为确保云端部署稳定性，测试数据已从初版的19门开课课程简化为13门核心课程，移除了以下6门课程的开课实例：
- ❌ CS202 编译原理
- ❌ SE202 移动应用开发  
- ❌ IS103 信息安全数学基础
- ❌ MATH103 概率论与数理统计
- ❌ MATH201 离散数学
- ❌ PHY101 大学物理A

**保留的13门课程**已验证无教室冲突、教师冲突和容量问题，可直接用于展示。

---

## 💡 日常使用场景

### 1. 添加数据(使用存储过程)

```sql
-- 添加学生
CALL sp_add_user('2024100', '张三', '123456', '学生', 1, @id, @msg);
SELECT @id, @msg;

-- 批量添加学生
CALL sp_batch_add_students('2024', 100, 50, 1, @count, @msg);
SELECT @count, @msg;

-- 添加课程
CALL sp_add_course('AI101', '人工智能', 3.0, 1, @msg);
SELECT @msg;

-- 学生选课
CALL sp_student_enroll(1, 5, @msg);
SELECT @msg;
```

### 2. 查询数据(从05_queries.sql复制)

```sql
-- 查询学生课表
CALL sp_get_student_schedule(1, 1);

-- 查询可选课程
CALL sp_get_available_courses(1);

-- 查询教师课表
CALL sp_get_teacher_schedule(2, 1);

-- 查询选课统计
CALL sp_get_enrollment_statistics(1);
```

### 3. 功能测试(执行06_test_cases.sql)

```sql
-- 执行全部测试
SOURCE /path/to/06_test_cases.sql;

-- 或只执行某部分测试(复制对应代码)
SELECT '========== 测试3: 存储过程功能验证 ==========' AS '测试项目';
-- ... 复制第三部分的SQL
```

---

## 🎯 常见操作示例

### 添加新学期

```sql
INSERT INTO `学期信息表` (`学年`, `学期类型`, `开始日期`, `结束日期`, 
                        `选课开始时间`, `选课结束时间`, `是否当前学期`) 
VALUES ('2025-2026', '春季', '2026-02-20', '2026-06-30', 
        '2026-02-01 09:00:00', '2026-02-25 17:00:00', FALSE);
```

### 创建开课实例并排课

```sql
-- 1. 创建开课实例
CALL sp_create_course_instance('CS101', 1, 5, 40, 10, @instance_id, @msg);

-- 2. 分配教师
CALL sp_assign_teacher(2, @instance_id, @msg);

-- 3. 添加上课时间(全学期)
CALL sp_add_schedule_time(@instance_id, 1, 2, 1, 16, '全部', @time_id, @msg);

-- 4. 添加实验课(单周)
CALL sp_add_schedule_time(@instance_id, 3, 2, 1, 16, '单周', @time_id, @msg);
```

### 学生选课流程

```sql
-- 1. 查看可选课程
CALL sp_get_available_courses(1);

-- 2. 选课
CALL sp_student_enroll(1, 5, @msg);
SELECT @msg;  -- 查看选课结果

-- 3. 查看课表
CALL sp_get_student_schedule(1, 1);

-- 4. 退课(如果需要)
CALL sp_student_drop(1, 5, @msg);
SELECT @msg;
```

---

## ⚠️ 注意事项

### 部署相关
1. **首次部署**: 使用 `00_deploy_all.sql` 一键部署
2. **执行顺序**: 严格按照 01 → 02 → 03 → 04 的顺序
3. **数据重置**: 使用 `00_clear_data.sql` 快速清理数据（保留结构）
4. **触发器数量**: 当前为11个（已移除2个学期管理触发器，因MySQL限制）

### 使用相关
5. **触发器自动生效**: 插入数据后,触发器会自动检查冲突和更新计数
6. **存储过程返回值**: 注意检查 OUT 参数的返回信息
7. **周次管理**: 起始周和结束周范围为1-16,单双周可选'全部'/'单周'/'双周'
8. **星期字段**: 必须使用 `'星期一'` 格式，不能用 `'周一'`

### 已知限制
9. **学期管理**: 由于MySQL触发器限制，学期切换需手动执行两条UPDATE语句（详见02_triggers.sql注释）
10. **测试数据**: 当前为简化版13门课程，可根据需要扩展（需注意冲突检测）

---

## 🔍 故障排查

### 问题1: "排课失败: 教室时间冲突"
- **原因**: 同一教室、同一时间段、周次重叠且单双周匹配
- **解决**: 
  - 检查 `上课时间表` 是否有冲突
  - 修改教室ID或时间段ID或周次范围
  - 使用00_clear_data.sql重置数据后重新执行

### 问题2: "开课失败: 总名额超过教室容量"
- **原因**: `对内名额 + 对外名额 > 教室容量`
- **解决**: 减少名额或更换更大的教室

### 问题3: "选课失败: 上课时间冲突"
- **原因**: 学生已选课程与新课程的时间段、周次存在冲突
- **解决**: 选择其他时间不冲突的课程

### 问题4: 触发器数量显示不是11
- **原因**: 可能多次执行02_triggers.sql
- **解决**: 执行 `00_rebuild.sql` 后重新部署

### 问题5: 查询结果为空
- **原因**: 可能是星期字段值错误或学期ID错误
- **解决**: 
  - 确保使用 `'星期一'` 而不是 `'周一'`
  - 当前学期ID为4（2024-2025春季）

### 问题6: 存储过程找不到
- **原因**: 未执行03_procedures.sql
- **解决**: 重新执行 `SOURCE 03_procedures.sql`

---

## � 项目亮点（展示时重点说明）

### 1. 周次灵活管理（创新点）
- ✨ 支持**全学期**、**前/后8周**、**单周/双周**等多种排课模式
- ✨ 自动检测周次冲突（例如：全学期课程与前8周课程不冲突）
- ✨ 实际案例：
  - 计算机组成原理：前8周理论 + 后8周实验
  - 数据库系统：全学期理论 + 单周实验
  - 大学物理实验：双周实验课

### 2. 智能冲突检测（核心功能）
- ✨ **教室冲突**: 同教室+同时间+周次重叠+单双周匹配 → 自动拦截
- ✨ **教师冲突**: 同教师+同时间+周次重叠 → 自动拦截
- ✨ **学生冲突**: 同学生+同时间+周次重叠 → 选课时自动拦截
- ✨ **容量检测**: 总名额超过教室容量 → 开课时自动拦截
- ✨ **名额检测**: 选课人数达到上限 → 选课时自动拦截

### 3. 跨院系选课（实用功能）
- ✨ 自动区分**对内名额**和**对外名额**
- ✨ 支持院系间课程资源共享
- ✨ 自动计算和更新已选人数

### 4. 存储过程封装（易用性）
- ✨ 14个存储过程覆盖常用操作
- ✨ 统一的返回值格式（@msg返回操作结果）
- ✨ 批量操作支持（如批量添加学生）

### 5. 三层视图设计（简化查询）
- ✨ **当前学期开课视图**: 快速查看本学期所有课程
- ✨ **学生课表视图**: 一键查看学生完整课表
- ✨ **教师课表视图**: 一键查看教师授课安排

---

## 📞 支持与文档

### 相关文档
- **00_fix_report.md**: 开发过程中的问题修复记录（含触发器优化说明）
- **05_queries.sql**: 30+个查询示例，覆盖常见业务场景
- **06_test_cases.sql**: 31个测试用例，验证系统功能完整性

### 技术栈
- **数据库**: MySQL 8.0 / 华为云 GaussDB
- **字符集**: utf8mb4
- **存储引擎**: InnoDB
- **触发器**: 11个（BEFORE INSERT/UPDATE/DELETE）
- **存储过程**: 14个（参数化操作）
- **视图**: 3个（多表关联查询）

### 后续计划
- ⏳ 前端界面开发（Vue.js + Element UI）
- ⏳ RESTful API开发（Spring Boot）
- ⏳ 学生/教师/教务三端功能完善
- ⏳ 选课系统压力测试
- ⏳ 移动端适配

---

## 🎓 项目总结

本项目实现了一个功能完整的高校排课选课管理系统数据库层，具备以下特点：

1. **实用性强**: 贴近真实高校选课场景，支持跨院系选课、周次管理等实际需求
2. **可靠性高**: 11个触发器保证数据一致性，自动检测各类冲突
3. **易用性好**: 14个存储过程封装复杂操作，3个视图简化查询
4. **扩展性强**: 表结构设计规范，预留扩展字段，支持功能扩充
5. **创新性**: 周次灵活管理功能为系统亮点，支持多种排课模式

**适合用于**：数据库课程设计、毕业设计、教学管理系统开发参考。
