# 教务开课管理功能

## 📅 更新日期
2025-11-02

## 🎯 功能说明

### 新增功能：开课管理
教务人员现在可以通过"开课管理"页面创建完整的开课实例，包括：
1. ✅ 基本信息（课程、学期、教室、名额）
2. ✅ 授课教师（可多位教师）
3. ✅ 上课时间（多个时间段）

## 📋 创建流程

### 步骤1：基本信息
- **选择课程**：从已创建的课程列表中选择
- **选择学期**：2024-2025秋季等
- **选择教室**：显示教室容量，自动检查是否超额
- **设置名额**：
  - 对内名额：本院系学生可选
  - 对外名额：跨院系学生可选
  - 系统自动验证总名额≤教室容量

### 步骤2：授课教师
- 可选择一位或多位教师共同授课
- 教师列表显示姓名、工号、院系信息
- 支持搜索过滤

### 步骤3：上课时间
- **添加多个时间段**：
  - 星期：周一至周日
  - 时间段：1-2节(08:00-09:50)、3-4节等
  - 周次范围：1-20周
  - 单双周：全部/单周/双周
  - 授课教师：为每个时间段指定教师

## 🎨 界面特点

### 分步向导
```
步骤1: 基本信息 → 步骤2: 授课教师 → 步骤3: 上课时间
   [课程/教室/名额]    [选择教师]      [配置时间表]
```

### 智能验证
- ✅ 实时计算总名额
- ✅ 与教室容量对比
- ✅ 超额时显示警告
- ✅ 时间段完整性检查

### 灵活配置
- 支持多位教师
- 支持多个时间段
- 支持周次范围和单双周
- 每个时间段可指定不同教师

## 🗂️ 文件清单

### 前端
- ✅ `frontend/src/views/admin/InstanceManagement.vue` - 开课管理页面（新建）
- ✅ `frontend/src/router/index.js` - 添加路由
- ✅ `frontend/src/views/admin/Layout.vue` - 添加菜单项

### 数据库（已有存储过程）
- ✅ `sp_create_course_instance` - 创建开课实例
- ✅ `sp_assign_teacher` - 分配授课教师
- ✅ `sp_add_schedule_time` - 添加上课时间

### 后端（待实现）
- ⏳ 创建开课实例API
- ⏳ 获取教室列表API
- ⏳ 获取学期列表API
- ⏳ 获取开课实例列表API

## 📝 使用示例

### 示例：创建"数据结构"开课实例

**步骤1：基本信息**
- 课程：数据结构 (CS201)
- 学期：2024-2025 秋季
- 教室：主楼 301（容量80人）
- 对内名额：50人
- 对外名额：20人
- ✅ 总名额70人 < 教室容量80人

**步骤2：授课教师**
- 选择：张三教授、李四副教授

**步骤3：上课时间**
| 星期 | 时间 | 周次 | 单双周 | 教师 |
|------|------|------|--------|------|
| 星期一 | 08:00-09:50 | 1-16周 | 全部 | 张三教授 |
| 星期三 | 14:00-15:50 | 1-16周 | 全部 | 张三教授 |
| 星期五 | 10:10-12:00 | 1-8周 | 单周 | 李四副教授 |

**结果**：
- 创建开课实例ID：123
- 建立授课关系：张三、李四
- 添加3个上课时间段

## 🔄 调用流程

### 后端API调用顺序
```
1. POST /admin/instances
   ↓ 创建开课实例
   ↓ 返回 instance_id
   ↓
2. POST /admin/instances/{id}/teachers
   ↓ 为每位教师调用
   ↓ 建立授课关系
   ↓
3. POST /admin/instances/{id}/schedules
   ↓ 为每个时间段调用
   ↓ 添加上课时间
   ↓
✅ 完成
```

### 数据库存储过程调用
```sql
-- 1. 创建开课实例
CALL sp_create_course_instance(
    'CS201',  -- 课程ID
    5,        -- 教室ID
    1,        -- 学期ID
    50,       -- 对内名额
    20,       -- 对外名额
    @instance_id,
    @message
);

-- 2. 分配教师（多次调用）
CALL sp_assign_teacher(16, @instance_id, @message);  -- 张三
CALL sp_assign_teacher(17, @instance_id, @message);  -- 李四

-- 3. 添加上课时间（多次调用）
CALL sp_add_schedule_time(
    @instance_id,  -- 开课实例ID
    1,             -- 时间段ID（周一1-2节）
    16,            -- 教师ID（张三）
    1,             -- 起始周
    16,            -- 结束周
    '全部',        -- 单双周
    @schedule_id,
    @message
);
-- ... 重复调用添加其他时间段
```

## 🚀 部署说明

### 前端部署
```bash
# 前端代码已完成，刷新浏览器即可看到新菜单
# 教务登录后，左侧菜单会显示"开课管理"
```

### 后端待实现API

#### 1. 创建开课实例
```python
# backend/app/api/admin.py

@router.post("/instances", response_model=ResponseModel[dict])
async def create_instance(request: CreateInstanceRequest):
    """
    创建开课实例（包含教师和时间段）
    """
    # 1. 调用 sp_create_course_instance
    # 2. 循环调用 sp_assign_teacher
    # 3. 循环调用 sp_add_schedule_time
    pass
```

#### 2. 获取教室列表
```python
@router.get("/classrooms", response_model=ResponseModel[List[dict]])
async def get_classrooms():
    """
    获取所有教室
    SELECT * FROM 教室信息表
    """
    pass
```

#### 3. 获取学期列表
```python
@router.get("/semesters", response_model=ResponseModel[List[dict]])
async def get_semesters():
    """
    获取所有学期
    SELECT * FROM 学期信息表
    """
    pass
```

#### 4. 获取开课实例列表
```python
@router.get("/instances", response_model=ResponseModel[List[dict]])
async def get_instances(semester_id: int = None):
    """
    获取开课实例列表（含统计信息）
    """
    pass
```

## ✅ 验证测试

### 功能测试清单
- [ ] 步骤1：选择课程、学期、教室
- [ ] 步骤1：设置对内、对外名额
- [ ] 步骤1：总名额超教室容量时显示警告
- [ ] 步骤2：选择单个教师
- [ ] 步骤2：选择多个教师
- [ ] 步骤3：添加时间段
- [ ] 步骤3：删除时间段
- [ ] 步骤3：配置周次和单双周
- [ ] 步骤3：为时间段指定教师
- [ ] 提交：验证时间段完整性
- [ ] 提交：成功创建开课实例

### 边界测试
- [ ] 对内名额=0，对外名额>0
- [ ] 总名额=教室容量（临界值）
- [ ] 总名额>教室容量（应报错）
- [ ] 未选择教师
- [ ] 未添加时间段（应提示）
- [ ] 时间段信息不完整（应提示）

## 💡 使用技巧

1. **分步填写**：利用分步向导，逐步完成配置
2. **容量检查**：注意观察总名额与教室容量的对比
3. **教师分配**：可以在步骤3为不同时间段指定不同教师
4. **灵活排课**：支持单周/双周，适应不同教学安排

## 🎉 优势

- ✨ **一站式创建**：一个流程完成所有配置
- ✨ **智能验证**：实时检查数据合法性
- ✨ **灵活配置**：支持多教师、多时间段
- ✨ **直观操作**：分步向导，降低操作难度
- ✨ **数据完整**：确保创建的开课实例信息完整

## 📌 注意事项

1. 必须先在"课程管理"中创建课程
2. 教室容量限制会严格检查
3. 时间冲突由数据库触发器自动检测
4. 每个时间段可以指定不同的授课教师
