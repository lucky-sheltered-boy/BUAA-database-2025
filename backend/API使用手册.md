# é«˜æ ¡æ™ºèƒ½æ’è¯¾é€‰è¯¾ç®¡ç†ç³»ç»Ÿ - API ä½¿ç”¨æ‰‹å†Œ

**ç‰ˆæœ¬**: 1.0.0  
**åŸºäº**: FastAPI + åä¸ºäº‘ TaurusDB  
**æ–‡æ¡£æ›´æ–°æ—¥æœŸ**: 2025-10-30

---

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [API æ–‡æ¡£è®¿é—®](#api-æ–‡æ¡£è®¿é—®)
3. [è®¤è¯è¯´æ˜](#è®¤è¯è¯´æ˜)
4. [æ¥å£åˆ—è¡¨](#æ¥å£åˆ—è¡¨)
5. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
6. [æµ‹è¯•è´¦å·](#æµ‹è¯•è´¦å·)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```powershell
cd backend
python -m uvicorn app.main:app --reload --port 8000
```

ç­‰å¾…çœ‹åˆ°ï¼š
```
INFO:     Application startup complete.
```

### 2. è®¿é—® API æ–‡æ¡£

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š**http://localhost:8000/docs**

### 3. æµ‹è¯•ç™»å½•

åœ¨ Swagger UI ä¸­ï¼š
1. æ‰¾åˆ° `POST /api/auth/login`
2. ç‚¹å‡» "Try it out"
3. è¾“å…¥æµ‹è¯•è´¦å·ï¼š
   ```json
   {
     "username": "2021001",
     "password": "123456"
   }
   ```
4. ç‚¹å‡» "Execute"
5. å¤åˆ¶è¿”å›çš„ `access_token`

### 4. é…ç½®è®¤è¯

1. ç‚¹å‡»é¡µé¢é¡¶éƒ¨çš„ **Authorize** æŒ‰é’®
2. åœ¨å¼¹å‡ºæ¡†ä¸­è¾“å…¥ï¼š`Bearer <ä½ å¤åˆ¶çš„token>`
3. ç‚¹å‡» "Authorize" â†’ "Close"

ç°åœ¨å¯ä»¥æµ‹è¯•æ‰€æœ‰æ¥å£äº†ï¼

---

## ğŸ“š API æ–‡æ¡£è®¿é—®

| æ–‡æ¡£ç±»å‹ | åœ°å€ | è¯´æ˜ |
|---------|------|------|
| **Swagger UI** | http://localhost:8000/docs | äº¤äº’å¼APIæ–‡æ¡£ï¼Œå¯ç›´æ¥æµ‹è¯• âœ…æ¨è |
| **ReDoc** | http://localhost:8000/redoc | ç¾è§‚çš„åªè¯»æ–‡æ¡£ |
| **OpenAPI JSON** | http://localhost:8000/openapi.json | æœºå™¨å¯è¯»çš„APIè§„èŒƒ |
| **å¥åº·æ£€æŸ¥** | http://localhost:8000/health | æœåŠ¡çŠ¶æ€æ£€æŸ¥ |

---

## ğŸ” è®¤è¯è¯´æ˜

### JWT Token è®¤è¯

æœ¬ç³»ç»Ÿä½¿ç”¨ JWT (JSON Web Token) è¿›è¡Œèº«ä»½è®¤è¯ã€‚

#### Token è·å–

é€šè¿‡ `POST /api/auth/login` ç™»å½•è·å–ï¼š

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 1800,
  "user_info": {
    "user_id": 16,
    "username": "2021001",
    "name": "å¼ ä¸‰",
    "role": "å­¦ç”Ÿ",
    "department_name": "è®¡ç®—æœºå­¦é™¢"
  }
}
```

#### Token ä½¿ç”¨

åœ¨éœ€è¦è®¤è¯çš„æ¥å£ä¸­ï¼Œæ·»åŠ  Headerï¼š
```
Authorization: Bearer <access_token>
```

âš ï¸ **æ³¨æ„**ï¼š
- `Bearer` åé¢æœ‰ä¸€ä¸ª**ç©ºæ ¼**
- Token æœ‰æ•ˆæœŸä¸º **30åˆ†é’Ÿ**
- Token è¿‡æœŸåéœ€é‡æ–°ç™»å½•æˆ–ä½¿ç”¨ refresh_token åˆ·æ–°

#### åœ¨ Swagger UI ä¸­ä½¿ç”¨

1. ç™»å½•è·å– token
2. ç‚¹å‡»é¡µé¢é¡¶éƒ¨çš„ **Authorize** æŒ‰é’®
3. è¾“å…¥ï¼š`Bearer <token>`
4. æ‰€æœ‰åç»­è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦æ­¤ token

---

## ğŸ“– æ¥å£åˆ—è¡¨

### ğŸ”‘ è®¤è¯æ¥å£ (auth)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | éœ€è¦è®¤è¯ |
|------|------|------|---------|
| POST | `/api/auth/login` | ç”¨æˆ·ç™»å½• | âŒ |
| POST | `/api/auth/refresh` | åˆ·æ–° token | âŒ |

### ğŸ‘¨â€ğŸ“ å­¦ç”Ÿæ¥å£ (students)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | éœ€è¦è®¤è¯ |
|------|------|------|---------|
| GET | `/api/students/{student_id}/available-courses` | æŸ¥è¯¢å¯é€‰è¯¾ç¨‹ | âœ… |
| POST | `/api/students/{student_id}/enroll` | é€‰è¯¾ | âœ… |
| POST | `/api/students/{student_id}/drop` | é€€è¯¾ | âœ… |
| GET | `/api/students/{student_id}/schedule` | æŸ¥çœ‹è¯¾è¡¨ | âœ… |

### ğŸ‘¨â€ğŸ« æ•™å¸ˆæ¥å£ (teachers)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | éœ€è¦è®¤è¯ |
|------|------|------|---------|
| GET | `/api/teachers/{teacher_id}/schedule` | æŸ¥çœ‹æˆè¯¾å®‰æ’ | âœ… |
| GET | `/api/teachers/{teacher_id}/students` | æŸ¥çœ‹å­¦ç”Ÿåå• | âœ… |

### ğŸ“Š ç»Ÿè®¡æ¥å£ (statistics)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | éœ€è¦è®¤è¯ |
|------|------|------|---------|
| GET | `/api/statistics/enrollment` | é€‰è¯¾ç»Ÿè®¡ | âœ… |
| GET | `/api/statistics/overview` | ç³»ç»Ÿæ¦‚è§ˆ | âœ… |

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: å­¦ç”Ÿé€‰è¯¾å®Œæ•´æµç¨‹

#### Step 1: ç™»å½•

**è¯·æ±‚**:
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "2021001",
  "password": "123456"
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "access_token": "eyJhbG...",
    "user_info": {
      "user_id": 16,
      "username": "2021001",
      "name": "å¼ ä¸‰",
      "role": "å­¦ç”Ÿ"
    }
  }
}
```

#### Step 2: æŸ¥çœ‹å¯é€‰è¯¾ç¨‹

**è¯·æ±‚**:
```http
GET /api/students/16/available-courses
Authorization: Bearer eyJhbG...
```

**å“åº”**:
```json
{
  "success": true,
  "message": "æŸ¥è¯¢åˆ° 5 é—¨å¯é€‰è¯¾ç¨‹",
  "data": [
    {
      "instance_id": 1,
      "course_id": "CS101",
      "course_name": "æ•°æ®ç»“æ„",
      "credit": 3.0,
      "department": "è®¡ç®—æœºå­¦é™¢",
      "building": "æ•™å­¦æ¥¼A",
      "room": "101",
      "remaining_quota": 58,
      "enroll_type": "å¯¹å†…"
    }
  ]
}
```

#### Step 3: é€‰è¯¾

**è¯·æ±‚**:
```http
POST /api/students/16/enroll
Authorization: Bearer eyJhbG...
Content-Type: application/json

{
  "instance_id": 1
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "é€‰è¯¾æˆåŠŸ",
  "data": null
}
```

#### Step 4: æŸ¥çœ‹è¯¾è¡¨

**è¯·æ±‚**:
```http
GET /api/students/16/schedule?semester_id=4
Authorization: Bearer eyJhbG...
```

**å“åº”**:
```json
{
  "success": true,
  "message": "æŸ¥è¯¢åˆ° 3 æ¡è¯¾ç¨‹å®‰æ’",
  "data": [
    {
      "course_id": "CS101",
      "course_name": "æ•°æ®ç»“æ„",
      "credit": 3.0,
      "weekday": "æ˜ŸæœŸä¸€",
      "start_time": "08:00:00",
      "end_time": "09:40:00",
      "building": "æ•™å­¦æ¥¼A",
      "room": "101",
      "teacher_name": "å¼ æ•™æˆ",
      "week_range": "1-16å‘¨",
      "week_type": "æ¯å‘¨"
    }
  ]
}
```

### ç¤ºä¾‹ 2: æ•™å¸ˆæŸ¥çœ‹å­¦ç”Ÿåå•

**è¯·æ±‚**:
```http
GET /api/teachers/1/students?instance_id=1
Authorization: Bearer <teacher_token>
```

**å“åº”**:
```json
{
  "success": true,
  "message": "æŸ¥è¯¢åˆ° 5 åå­¦ç”Ÿ",
  "data": [
    {
      "student_id": 16,
      "student_number": "2021001",
      "student_name": "å¼ ä¸‰",
      "department": "è®¡ç®—æœºå­¦é™¢",
      "enroll_type": "å¯¹å†…",
      "enroll_time": "2024-09-01 10:30:00"
    }
  ]
}
```

### ç¤ºä¾‹ 3: é€€è¯¾

**è¯·æ±‚**:
```http
POST /api/students/16/drop
Authorization: Bearer eyJhbG...
Content-Type: application/json

{
  "instance_id": 1
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "é€€è¯¾æˆåŠŸ",
  "data": null
}
```

---

## ğŸ‘¥ æµ‹è¯•è´¦å·

### å­¦ç”Ÿè´¦å·

| å­¦å· | å¯†ç  | å§“å | å­¦é™¢ | ç”¨æˆ·ID |
|------|------|------|------|--------|
| 2021001 | 123456 | å¼ ä¸‰ | è®¡ç®—æœºå­¦é™¢ | 16 |
| 2021002 | 123456 | æå›› | è®¡ç®—æœºå­¦é™¢ | 17 |
| 2021003 | 123456 | ç‹äº” | è®¡ç®—æœºå­¦é™¢ | 18 |
| 2021101 | 123456 | éƒ‘ä¸€ | è½¯ä»¶å­¦é™¢ | 24 |
| 2021201 | 123456 | å¾ä¸ƒ | ä¿¡æ¯å®‰å…¨å­¦é™¢ | 32 |

### æ•™å¸ˆè´¦å·

| å·¥å· | å¯†ç  | å§“å | ç”¨æˆ·ID |
|------|------|------|--------|
| T1001 | 123456 | å¼ æ•™æˆ | 1 |
| T002 | 123456 | ææ•™æˆ | 2 |
| T003 | 123456 | ç‹è®²å¸ˆ | 3 |

### æ•™åŠ¡è´¦å·

| å·¥å· | å¯†ç  | å§“å | ç”¨æˆ·ID |
|------|------|------|--------|
| A001 | 123456 | ç‹æ•™åŠ¡ | 14 |
| A002 | 123456 | æä¸»ç®¡ | 15 |

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ‰¾åˆ° Authorize æŒ‰é’®ï¼Ÿ

A: Authorize æŒ‰é’®ä½äº Swagger UI é¡µé¢**é¡¶éƒ¨**ï¼Œåœ¨æ ‡é¢˜å’Œæ¥å£åˆ—è¡¨ä¹‹é—´ï¼š

```
é«˜æ ¡æ™ºèƒ½æ’è¯¾é€‰è¯¾ç®¡ç†ç³»ç»Ÿ
Version: 1.0.0
åŸºäº FastAPI + åä¸ºäº‘ TaurusDB...

[Authorize] ğŸ”“  â† åœ¨è¿™é‡Œ

Servers
http://localhost:8000
```

åˆ·æ–°é¡µé¢å¹¶æ»šåŠ¨åˆ°æœ€é¡¶éƒ¨å³å¯çœ‹åˆ°ã€‚

### Q2: ç™»å½•åæç¤º 401 Unauthorizedï¼Ÿ

A: å¯èƒ½çš„åŸå› ï¼š
1. **Token æœªé…ç½®**ï¼šç‚¹å‡» Authorize æŒ‰é’®é…ç½® token
2. **Token æ ¼å¼é”™è¯¯**ï¼šç¡®ä¿æ ¼å¼ä¸º `Bearer <token>`ï¼ˆBearer åæœ‰ç©ºæ ¼ï¼‰
3. **Token è¿‡æœŸ**ï¼šé‡æ–°ç™»å½•æˆ–ä½¿ç”¨ refresh token

### Q3: é€‰è¯¾æ—¶æç¤ºæ—¶é—´å†²çªï¼Ÿ

A: ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æ—¶é—´å†²çªï¼Œå¦‚æœæç¤ºå†²çªï¼š
1. å…ˆæŸ¥çœ‹å½“å‰è¯¾è¡¨ï¼š`GET /api/students/{id}/schedule`
2. ç¡®è®¤æ–°è¯¾ç¨‹çš„æ—¶é—´å®‰æ’
3. å¦‚éœ€é€‰æ‹©ï¼Œå…ˆé€€æ‰å†²çªçš„è¯¾ç¨‹

### Q4: å¦‚ä½•æŸ¥çœ‹æŸå­¦æœŸçš„è¯¾è¡¨ï¼Ÿ

A: ä½¿ç”¨ `semester_id` å‚æ•°ï¼š
```
GET /api/students/16/schedule?semester_id=4
```

å½“å‰å¯ç”¨çš„å­¦æœŸIDï¼š
- `1`: 2023-2024ç§‹å­£
- `2`: 2023-2024æ˜¥å­£
- `3`: 2024-2025ç§‹å­£
- `4`: 2024-2025æ˜¥å­£ â­å½“å‰å­¦æœŸ

### Q5: PowerShell ä¸­å¦‚ä½•ä½¿ç”¨ curlï¼Ÿ

A: PowerShell ä¸­å»ºè®®ä½¿ç”¨ `curl.exe` å¹¶æ³¨æ„è½¬ä¹‰ï¼š

```powershell
curl.exe -X POST "http://localhost:8000/api/auth/login" `
  -H "Content-Type: application/json" `
  -d '{\"username\":\"2021001\",\"password\":\"123456\"}'
```

**æ¨èä½¿ç”¨ Swagger UI**ï¼Œæ¯” curl å‘½ä»¤ç®€å•å¾—å¤šï¼

### Q6: å¦‚ä½•åˆ‡æ¢ä¸åŒè§’è‰²æµ‹è¯•ï¼Ÿ

A: 
1. ç‚¹å‡» Authorize æŒ‰é’®
2. ç‚¹å‡» "Logout" é€€å‡ºå½“å‰è®¤è¯
3. ç”¨å…¶ä»–è´¦å·é‡æ–°ç™»å½•
4. é…ç½®æ–°çš„ token

### Q7: Token åŒ…å«ä»€ä¹ˆä¿¡æ¯ï¼Ÿ

A: JWT Token è§£ç ååŒ…å«ï¼š
```json
{
  "user_id": 16,
  "username": "2021001",
  "role": "å­¦ç”Ÿ",
  "exp": 1730062800
}
```

å¯ä»¥åœ¨ https://jwt.io ä¸ŠæŸ¥çœ‹ token å†…å®¹ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰ã€‚

### Q8: å¦‚ä½•æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Ÿ

A: æœåŠ¡å¯åŠ¨çš„ç»ˆç«¯ä¼šå®æ—¶æ˜¾ç¤ºæ—¥å¿—ï¼š
```
2025-10-30 03:26:43 | INFO  | ç”¨æˆ·ç™»å½•æˆåŠŸ: 2021001 (å­¦ç”Ÿ)
2025-10-30 03:27:10 | INFO  | å­¦ç”Ÿ 16 é€‰è¯¾æˆåŠŸ: å¼€è¯¾å®ä¾‹ 1
```

è¯¦ç»†æ—¥å¿—ä¿å­˜åœ¨ `logs/app.log` æ–‡ä»¶ä¸­ã€‚

---

## ğŸ¯ å“åº”æ ¼å¼è¯´æ˜

æ‰€æœ‰ API å“åº”å‡ä½¿ç”¨ç»Ÿä¸€æ ¼å¼ï¼š

### æˆåŠŸå“åº”

```json
{
  "success": true,
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": { /* å…·ä½“æ•°æ® */ }
}
```

### é”™è¯¯å“åº”

```json
{
  "success": false,
  "code": é”™è¯¯ç ,
  "message": "é”™è¯¯æè¿°",
  "data": null
}
```

### å¸¸è§çŠ¶æ€ç 

| çŠ¶æ€ç  | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| 200 | æˆåŠŸ | æ“ä½œæˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ | ç¼ºå°‘å¿…å¡«å­—æ®µ |
| 401 | æœªè®¤è¯ | Token æ— æ•ˆæˆ–è¿‡æœŸ |
| 403 | æ— æƒé™ | å­¦ç”Ÿæ— æ³•è®¿é—®æ•™å¸ˆæ¥å£ |
| 404 | èµ„æºä¸å­˜åœ¨ | ç”¨æˆ·IDä¸å­˜åœ¨ |
| 422 | ä¸šåŠ¡é€»è¾‘é”™è¯¯ | æ—¶é—´å†²çªã€åé¢å·²æ»¡ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æ•°æ®åº“è¿æ¥å¤±è´¥ |

---

## ğŸ“ å¼€å‘å»ºè®®

### 1. ä½¿ç”¨ Swagger UI å¼€å‘

- âœ… å¯è§†åŒ–ç•Œé¢ï¼Œæ˜“äºæµ‹è¯•
- âœ… è‡ªåŠ¨ç”Ÿæˆè¯·æ±‚ç¤ºä¾‹
- âœ… å®æ—¶æŸ¥çœ‹å“åº”æ•°æ®
- âœ… æ”¯æŒæ–‡ä»¶ä¸Šä¼ ç­‰å¤æ‚åœºæ™¯

### 2. æ³¨æ„å¹¶å‘é€‰è¯¾

é€‰è¯¾æ¥å£å·²å®ç°æ­»é”é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰ï¼Œä½†ä»å»ºè®®ï¼š
- é¿å…çŸ­æ—¶é—´å†…é‡å¤æäº¤
- æŸ¥çœ‹å“åº”æ¶ˆæ¯ç¡®è®¤æ“ä½œç»“æœ
- å¤±è´¥åæŸ¥çœ‹é”™è¯¯ä¿¡æ¯å†é‡è¯•

### 3. Token ç®¡ç†

- å‰ç«¯åº”ä¿å­˜ access_token å’Œ refresh_token
- Token å¿«è¿‡æœŸæ—¶è‡ªåŠ¨è°ƒç”¨ refresh æ¥å£
- é€€å‡ºç™»å½•æ—¶æ¸…é™¤æœ¬åœ° token

### 4. é”™è¯¯å¤„ç†

æ ¹æ® `success` å­—æ®µåˆ¤æ–­æˆåŠŸä¸å¦ï¼Œæ ¹æ® `code` åŒºåˆ†é”™è¯¯ç±»å‹ï¼š

```javascript
if (response.success) {
  // å¤„ç†æˆåŠŸ
  console.log(response.data);
} else {
  // å¤„ç†å¤±è´¥
  switch (response.code) {
    case 401:
      // è·³è½¬ç™»å½•é¡µ
      break;
    case 422:
      // æ˜¾ç¤ºä¸šåŠ¡é”™è¯¯æç¤º
      alert(response.message);
      break;
    // ...
  }
}
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [README.md](./README.md) - é¡¹ç›®å®Œæ•´è¯´æ˜
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../docs/è®¾è®¡æ–‡æ¡£.md) - æ•°æ®åº“è¡¨ç»“æ„è¯´æ˜
- [æ•°æ®åº“è„šæœ¬](../database/) - SQL å»ºè¡¨ã€å­˜å‚¨è¿‡ç¨‹ç­‰è„šæœ¬

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. ç»ˆç«¯æ—¥å¿—è¾“å‡º
2. `logs/app.log` æ—¥å¿—æ–‡ä»¶
3. Swagger UI çš„å“åº”è¯¦æƒ…
4. æ•°æ®åº“è§¦å‘å™¨å’Œå­˜å‚¨è¿‡ç¨‹çš„é”™è¯¯ä¿¡æ¯

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰
