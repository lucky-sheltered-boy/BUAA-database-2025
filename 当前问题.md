# 当前网站存在的问题

## 已修复问题
### 1. 教务端开课时间冲突检测不完整
**问题描述**：
- 在教务端新增开课时，仅检测了教室的时间冲突，未检测授课教师的时间冲突。
- 可能导致同一教师在同一时间段被安排多门课程。

**修复方案**：
- 后端：
    - 新增 API `GET /api/admin/teachers/{teacher_id}/occupied-slots`，用于查询指定教师在指定学期的所有授课时间段。
- 前端：
    - 修改 `frontend/src/views/admin/InstanceManagement.vue`。
    - 增加了 `teacherOccupiedSlots` 状态，并监听 `form.teacher_ids` 的变化。
    - 当选择教师后，自动获取其授课时间表。
    - `isOccupied` 函数现在同时检查教室占用和教师占用，任一冲突均标记为红色不可选。

### 2. 异常开课实例无法删除
**问题描述**：
- 用户存在一些历史遗留的异常开课实例（如无上课时间），尝试删除时系统报错。
- 原因：数据库触发器 `trg_before_course_instance_delete_check` 阻止了删除已有选课记录的实例，或者由于数据完整性问题导致删除失败。虽然用户描述是“没有指定开课时间”，但如果存在关联数据（如选课记录），触发器会拦截。

**修复方案**：
- 修改了 `backend/app/api/admin.py` 中的 `delete_instance` 接口。
- 在执行删除开课实例之前，显式执行 `DELETE FROM 选课记录表 WHERE 开课实例ID = ...`。
- 这样做既清理了关联数据，又规避了 `BEFORE DELETE` 触发器的限制，允许管理员强制删除异常实例。

### 3. 教务端新增开课时间验证错误
**问题描述**：
- 在教务端新增开课时，使用新的时间网格选择时间后，点击确定仍提示“请完善上课时间信息”。
- 原因：表单初始化时包含了一个空的默认时间段对象 `{ day_of_week: '', period: '' }`，该对象在提交验证时未通过，且未被网格选择逻辑清除。

**修复方案**：
- 修改了 `frontend/src/views/admin/InstanceManagement.vue`。
- 在 `handleAdd` 和 `handleEdit` 中，将 `form.time_slots` 初始化为空数组 `[]`，不再预置空对象。
- 在 `handleSubmit` 中增加了对 `time_slots` 长度的检查，确保至少选择了一个时间段。

### 4. 教务端开课时间选择优化
**问题描述**：
- 在教务端“开课管理”界面，新增开课时，上课时间的选择方式（下拉框）不直观。
- 缺乏冲突检测机制，无法直观看到教室在特定时间段是否已被占用。

**修复方案**：
- 后端：
    - 新增 API `GET /api/admin/classrooms/{classroom_id}/occupied-slots`，用于查询指定教室在指定学期的所有占用时间段。
    - 返回数据包含占用的星期、开始时间、结束时间以及课程名称。
- 前端：
    - 重构了 `frontend/src/views/admin/InstanceManagement.vue` 中的时间选择组件。
    - 废弃了原有的下拉框列表，改为可视化的**时间表网格（Time Grid）**。
    - 实现了动态冲突检测：当选择学期和教室后，自动获取占用情况。
    - 网格交互：
        - **红色**：表示该时间段已被其他课程占用（不可选）。
        - **绿色**：表示当前已选择的时间段。
        - **白色**：表示可选的空闲时间段。
    - 优化了编辑模式体验：在编辑现有课程时，该课程自身占用的时间段不会显示为冲突，允许用户取消或保留。

### 5. 学生端课表地点显示缺失
**问题描述**：
- 在学生端“我的课表”页面，下方的课表网格中，课程块只显示课程名称，未显示上课地点。

**修复方案**：
- 修改了 `frontend/src/views/student/MySchedule.vue` 的模板。
- 将原本引用的不存在的 `.location` 属性改为直接引用 `.building` 和 `.room` 属性。
- 确保了课表网格中能正确显示“教学楼+房间号”。

### 6. 教师端课表显示缺失
**问题描述**：
- 在教师端“我的课表”界面，课程列表显示正常，但下方的课表网格（Grid View）为空，不显示任何课程。

**修复方案**：
- 修改了 `frontend/src/views/teacher/MySchedule.vue` 中的 `getCourseAt` 函数。
- 实现了从“星期+节次”到“具体课程”的映射逻辑：
    - 将前端的 13 节课映射到数据库定义的 5 个时间段（如第1-2节对应 08:00:00）。
    - 修正了星期索引的处理（将星期日的索引 0 转换为 7，以匹配循环逻辑）。
    - 实现了基于 `start_time` 的课程查找。

### 7. 教师端“我的课表”选课人数统计错误
**问题描述**：
- 在教师端“我的课表”页面，课程卡片上显示的选课人数与实际学生名单人数不符（例如显示4人，实际只有2人）。
- 原因：数据库初始化脚本 `04_insert_data.sql` 中手动设置了初始选课人数，而后续插入选课记录时触发器再次累加，导致人数重复计算。

**修复方案**：
- 修正了 `database/04_insert_data.sql`，将所有开课实例的初始 `已选对内人数` 和 `已选对外人数` 设为 0。
- 执行了数据修复脚本，重置并重新计算了当前数据库中所有课程的选课人数，确保与 `选课记录表` 保持一致。

### 8. 学生端选课中心时间段显示错误
**问题描述**：
- 在学生端选课中心页面，可选课程的时间段显示为“周undefined 第3节”。
- 用户希望显示具体时间段（如“周二 14:00:00-15:40:00”），与“我的课表”保持一致。

**修复方案**：
- 后端：
    - 修改 `backend/app/api/students.py`，在查询可选课程的时间段信息时，增加了 `start_time` 和 `end_time` 字段的查询和返回。
- 前端：
    - 修改 `frontend/src/views/student/CourseSelection.vue` 中的 `formatTimeSlot` 函数。
    - 增加了对 `start_time` 和 `end_time` 的支持，优先显示具体时间段。
    - 修复了星期显示可能为 undefined 的问题（通过 `parseInt` 确保类型正确）。

### 9. 教师端概览统计错误
**问题描述**：
- 在开课程统计错误：将同一课程的不同时间段实例重复统计。
- 学生总数统计错误：重复累加同一课程实例的选课人数（例如一周两节课会导致人数翻倍）。
- 课程列表显示重复。

**修复方案**：
- 修改了 `frontend/src/views/teacher/Dashboard.vue` 中的 `fetchStats` 方法。
- 增加了数据预处理逻辑：
    1.  先根据 `instance_id` 对后端返回的课表数据进行去重，确保每个开课实例只计算一次。
    2.  基于去重后的数据统计课程总数（按 `course_id` 去重）和学生总数。
    3.  课程列表按 `course_id` 聚合展示，合并同一课程的选课人数。

### 10. 新增课程“隐身”及创建失败
**问题描述**：
- 在教务端新增课程实例后，学生端和教师端均无法看到该课程。
- 原因：后端计算“时间段ID”的公式 `(weekday - 1) * 5 + time_slot` 存在缺陷，当选择非连续时间段（如周末或第6节课以后）时，计算出的ID在数据库中不存在，导致 `sp_add_schedule_time` 存储过程执行失败。
- 由于事务回滚，虽然日志显示“创建实例成功”，但实际上数据并未保存。

**修复方案**：
- 修改了 `backend/app/api/admin.py` 中的 `create_instance` 接口。
    - 废弃了硬编码的ID计算公式。
    - 改为直接查询数据库 `时间段信息表`，根据星期和节次动态获取正确的 `时间段ID`。
    - 增加了校验逻辑：如果管理员选择了数据库中未配置的时间段（如周六或第6节课），系统将直接抛出明确的错误提示（例如“星期六没有配置第1节课的时间段”），而不是静默失败。
- 更新了数据库存储过程 `sp_add_schedule_time`。
    - 优化了错误处理机制，使用 `GET DIAGNOSTICS` 捕获并返回具体的数据库错误信息，便于排查问题。

## 待办事项
- [ ] 考虑在数据库中补充周末或晚间（第6节以后）的时间段数据，以支持更多排课需求。