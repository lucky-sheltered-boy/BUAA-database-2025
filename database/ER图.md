# 高校智能排课选课管理系统 - ER图

## 完整ER图（Mermaid格式）

```mermaid
erDiagram
    院系信息表 ||--o{ 用户信息表 : "包含"
    院系信息表 ||--o{ 课程信息表 : "开设"
    
    用户信息表 ||--o{ 授课关系表 : "教师授课"
    用户信息表 ||--o{ 选课记录表 : "学生选课"
    用户信息表 ||--o{ 上课时间表 : "教师授课时段"
    
    课程信息表 ||--o{ 开课实例表 : "开设实例"
    
    教室信息表 ||--o{ 开课实例表 : "使用教室"
    
    学期信息表 ||--o{ 开课实例表 : "在学期开设"
    
    时间段信息表 ||--o{ 上课时间表 : "占用时间段"
    
    开课实例表 ||--o{ 授课关系表 : "授课"
    开课实例表 ||--o{ 选课记录表 : "被选"
    开课实例表 ||--o{ 上课时间表 : "上课时间安排"
    
    院系信息表 {
        int 院系ID PK "主键,自增"
        varchar 院系名称 UK "唯一约束"
    }
    
    用户信息表 {
        int 用户ID PK "主键,自增"
        varchar 学号_工号 UK "唯一约束"
        varchar 姓名
        varchar 密码哈希
        enum 角色 "学生/教师/教务"
        int 院系ID FK "外键→院系信息表"
    }
    
    课程信息表 {
        varchar 课程ID PK "主键,课程代码"
        varchar 课程名称
        decimal 学分 "大于0"
        int 院系ID FK "外键→院系信息表"
    }
    
    教室信息表 {
        int 教室ID PK "主键,自增"
        varchar 教学楼
        varchar 房间号
        int 容量 "大于0"
    }
    
    时间段信息表 {
        int 时间段ID PK "主键,自增"
        enum 星期 "星期一~星期日"
        time 开始时间
        time 结束时间
    }
    
    学期信息表 {
        int 学期ID PK "主键,自增"
        varchar 学年 "如2024-2025"
        enum 学期类型 "春季/秋季"
        date 开始日期
        date 结束日期
        datetime 选课开始时间
        datetime 选课结束时间
        boolean 是否当前学期
    }
    
    开课实例表 {
        int 开课实例ID PK "主键,自增"
        varchar 课程ID FK "外键→课程信息表"
        int 教室ID FK "外键→教室信息表"
        int 学期ID FK "外键→学期信息表"
        int 对内名额 "大于0"
        int 对外名额 "大于等于0"
        int 已选对内人数 "默认0"
        int 已选对外人数 "默认0"
    }
    
    授课关系表 {
        int 教师ID PK_FK "复合主键,外键→用户信息表"
        int 开课实例ID PK_FK "复合主键,外键→开课实例表"
    }
    
    选课记录表 {
        int 学生ID PK_FK "复合主键,外键→用户信息表"
        int 开课实例ID PK_FK "复合主键,外键→开课实例表"
        timestamp 选课时间 "默认当前时间"
    }
    
    上课时间表 {
        int 上课时间ID PK "主键,自增"
        int 开课实例ID FK "外键→开课实例表"
        int 时间段ID FK "外键→时间段信息表"
        int 教师ID FK "外键→用户信息表,可空"
        int 起始周 "1-20,默认1"
        int 结束周 "1-20,默认16"
        enum 单双周 "全部/单周/双周"
    }
```

## 实体说明

### 基础实体（5个）

1. **院系信息表** - 存储学校的院系信息
2. **教室信息表** - 存储可用教室资源
3. **时间段信息表** - 定义上课的基本时间单元
4. **学期信息表** - 管理学期及选课时间窗口
5. **课程信息表** - 存储课程的抽象定义

### 核心实体（2个）

6. **用户信息表** - 统一管理学生、教师、教务三类用户
7. **开课实例表** - 记录课程在特定学期的具体安排（系统核心枢纽）

### 联系表（3个）

8. **授课关系表** - 教师与开课实例的M:N关系（支持多教师授课）
9. **选课记录表** - 学生与开课实例的M:N关系
10. **上课时间表** - 开课实例与时间段的M:N关系（含周次管理）

## 关系类型说明

### 1:N 关系（一对多）
- 院系 → 用户（一个院系包含多个用户）
- 院系 → 课程（一个院系开设多门课程）
- 课程 → 开课实例（一门课程可有多个开课实例）
- 学期 → 开课实例（一个学期有多个开课实例）
- 教室 → 开课实例（一个教室可被多个开课实例使用）

### M:N 关系（多对多）
- 教师 ←→ 开课实例（通过授课关系表，支持多教师分时段授课）
- 学生 ←→ 开课实例（通过选课记录表）
- 开课实例 ←→ 时间段（通过上课时间表，支持周次范围和单双周）

## 关键约束

### 主键约束
- 所有表都有主键
- 联系表使用复合主键

### 外键约束
- 所有外键都设置了参照完整性
- 级联删除：删除开课实例时级联删除授课关系、选课记录、上课时间

### 唯一约束
- 院系名称（防止重复）
- 学号/工号（防止重复）
- 教学楼+房间号（防止教室重复定义）
- 星期+开始时间+结束时间（防止时间段重复定义）

### 检查约束
- 学分 > 0
- 教室容量 > 0
- 对内名额 > 0，对外名额 ≥ 0
- 已选人数 ≤ 名额
- 总名额 ≤ 教室容量（通过触发器检查）
- 周次范围：1-20

## 业务规则体现

### 1. 跨院系选课
- 开课实例表中的"对内名额"和"对外名额"支持跨院系选课
- 本院系学生占对内名额，外院系学生占对外名额

### 2. 多教师授课
- 通过授课关系表和上课时间表的教师ID字段实现
- 支持"前半学期教师A，后半学期教师B"的场景

### 3. 周次灵活管理
- 上课时间表中的"起始周"、"结束周"、"单双周"字段
- 支持全学期、前/后8周、单周/双周等多种排课模式

### 4. 选课时间窗口
- 学期表中的"选课开始时间"和"选课结束时间"
- 触发器自动检查是否在允许的时间窗口内选课

### 5. 智能冲突检测
- 教师时间冲突：同教师+同时间段+周次重叠+单双周匹配
- 教室资源冲突：同教室+同时间段+周次重叠+单双周匹配
- 学生时间冲突：同学生+同时间段+周次重叠+单双周匹配
- 容量约束：总名额 ≤ 教室容量

## 数据流向

### 教务管理员操作流程
```
1. 创建开课实例 → 开课实例表
2. 分配教师 → 授课关系表
3. 安排上课时间 → 上课时间表（触发器检查教师/教室冲突）
```

### 学生选课流程
```
1. 查询可选课程 → 开课实例表（剩余名额）
2. 提交选课 → 选课记录表（触发器检查冲突/名额/时间窗口）
3. 更新已选人数 → 开课实例表（触发器自动更新）
```

### 教师查询流程
```
1. 查询个人课表 → 授课关系表 + 上课时间表
2. 查询学生名单 → 选课记录表
```

## 视图说明

系统还提供3个视图简化查询：

1. **当前学期开课实例视图** - 自动筛选当前学期并计算剩余名额
2. **学生选课详情视图** - 展示学生选课的完整信息
3. **教师授课详情视图** - 展示教师授课的完整信息

## 触发器保障

系统通过11个触发器自动维护数据一致性：

- **选课相关**：名额检查、时间冲突检查、人数自动更新
- **排课相关**：教师冲突检查、教室冲突检查
- **数据完整性**：防止非法修改、容量检查

---

**图例说明：**
- `PK` = Primary Key（主键）
- `FK` = Foreign Key（外键）
- `UK` = Unique Key（唯一键）
- `||--o{` = 一对多关系
- `}|--o{` = 多对多关系（通过中间表）
