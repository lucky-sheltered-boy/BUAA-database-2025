### 3. 优秀作业-《系统实现报告-问卷豆》.md

```markdown
# 《数据库系统原理》大作业 - 系统实现报告

## 题目名称：“问卷豆”问卷管理平台

**学号及姓名：**
- 20373087 夏雨阳
- 20373400 欧阳皓东
- 20185614 王默晗

**2022年12月23日**

---

## 一. 系统结构设计

### 1.1 体系结构

采用前端、后端、数据库分离的体系结构。
-   **前端**：与用户交互，显示数据库数据并且接收用户修改数据的请求。
-   **后端**：将数据库数据传送给前端、接收前端请求并且传递给数据库，调用数据库存储过程或者直接执行 SQL 命令。
-   **数据库**：存储、管理数据。

具体实现环境如下。

#### 1.1.1 前端
前端采用 `vue3+element-ui` 作为基本框架。脚本语言使用 ES6 标准的JavaScript。

#### 1.1.2 后端
后端采用 `django` 框架。这是一个 python 框架，具有 python 代码抽象程度高的优势，适合作为小型网站的后端。

#### 1.1.3 前后端通信
采用 `axios` 进行前后端通信。前端通过 axios 的 request 方法向指定 url 发送请求，请求格式为 json 字符串。后端从 urls 数组中匹配到这一请求的 url，并将其分配给对应的接口。

#### 1.1.4 数据库
数据库采用 `MySQL`，这是非常流行的关系数据库，使用SQL 语言。我们使用的 MySQL 的版本为8.0.30，它支持了 Json 字符串处理功能，便于在存储过程中进行部分数据处理。

`[系统体系结构图]`

### 1.2 功能结构
网站实现了三个系统：用户系统，问卷系统，团队系统。
- **用户系统**实现了用户登录注册，修改个人信息，上传用户头像，填写网站评价反馈表的功能。
- **问卷系统**实现了创建、编辑、预览、发布/停止问卷，填写问卷，查看问卷答卷情况（支持可视化），贡献模板问卷等功能。
- **团队系统**包含三类权限的用户：群主，管理员，普通成员，实现了创建团队，加入团队，踢出成员，授予/取消管理员权限，审核申请，退出团队，修改团队信息，创建/填写团队问卷等功能。

---

## 二. 数据库建表语句

#### (1) 用户表
用户表记录了用户名，密码，真实姓名，手机，生日，自我介绍，头像 id等信息。其中 id 和 user_name 是候选码。
```sql
create table user (
    id int primary key auto_increment,
    user_name char(10) unique not null,
    password char(10) not null,
    ...
);
```

#### (2) 问卷表
一个问卷由问卷题目，问卷序言，多个问题组成。问卷表记录了问卷 id, 问卷创建者 id, 问卷标题, 问卷描述等信息。
```sql
create table questionnaire (
    id int primary key auto_increment,
    user_id int not null,
    title char(255) default '',
    preface varchar(8192) not null,
    ...
    foreign key(user_id) references user(id),
    foreign key(team_id) references team(id)
);
```
*(后续建表语句省略，格式同上)*

---

## 三、系统重要功能实现方法

### 3.1 触发器设计与实现说明

在问卷系统中，一个问卷对应多个问题，一个问题对应多个问题项。删除问卷时，需要删除它的所有问题，删除问题时，需要删除它的所有问题项。为了保证这一删除约束，引入两个触发器，当删除问卷时，递归地删除它的所有问题，当删除问题时，递归地删除它的所有问题项。

```sql
-- 删除问题时，自动删除该问题下的所有问题项
create trigger delete_question before delete on question
for each row
begin
    delete from question_item where question_id = old.id;
end;

-- 删除问卷时，自动删除该问卷下的所有问题
create trigger delete_questionnaire before delete on questionnaire
for each row
begin
    delete from question where questionnaire_id = old.id;
end;
```

### 3.2 存储过程的设计与实现说明

#### 3.2.1 save_form
这一存储过程用于保存编辑后的问卷。它的输入是问卷 id, 问卷标题, 问卷序言, 以及问题数组。存储过程首先更新问卷表中的问卷标题、序言字段，然后删除问卷的所有问题以及相应的问题项，最后把问题数组中问题及相应问题项存进问题表、问题项表。

```sql
create procedure save_form(in form_id int, in new_title char(255), in new_preface varchar(8192), in questions varchar(8192))
begin
    -- 声明变量
    declare _question varchar (8192);
    ...

    start transaction;

    -- 更新问卷表
    update questionnaire set title = new_title, preface = new_preface where id = form_id;
    
    -- 先删除旧的所有问题
    delete from question where questionnaire_id = form_id;

    -- 循环插入新的问题和问题项
    select json_length(questions) into _n_question;
    while i < _n_question do
        -- ... 解析JSON并插入 ...
        set i = i + 1;
    end while;

    commit;
end;
```

*(后续存储过程省略，格式同上)*

---

## 四、系统实现结果

#### 4.1 注册页面
`[截图：注册页面]`

#### 4.2 登录页面
`[截图：登录页面]`

#### 4.3 问卷系统主页面
`[截图：问卷系统主页面]`

#### 4.4 创建问卷页面
`[截图：创建问卷页面]`

*(后续截图展示省略)*

---

## 五、总结

本次数据库大作业是一个中等规模的数据库系统（6-8个实体，联系不限）。我们团队要做的是零开始，学习前后端开发（课外），学习SQL 的使用（第三章），学习数据库的设计（第六章），然后才能完成这个项目。

... (总结内容省略)

值得一提的时，我们项目的后端没有采用 django 框架实现数据库的增删改查，而是直接手撸 SQL，实现了一个个存储过程，并将其封装成了事务（start transaction - commit）。这样训练了我们写 SQL 的能力，也是我们对于自身的挑战（用 MySQL 库函数手搓 json 字符串数组非常酸爽）。

这次数据库大作业让我们有以下收获:
(1) 前后端开发能力。
(2) SQL 使用能力，后期我们的实体数量增多，表的字段随着需求变化也增多了，各种连表，exists，临时表，tricks 满天飞，这大大提高了我们 SQL 的功底。
(3) 团队合作能力。最开始的选题我们通过问卷星投票商定，中间的开发我们结对编程，分工明确，锻炼了我们的团队分工能力。
(4) 抗压能力。在烤漆我们顶住了压力，完善了大作业的功能。
```