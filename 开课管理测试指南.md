# 开课管理功能测试指南

## 🚀 启动服务

### 后端服务
```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```
✅ 后端已启动在：http://localhost:8000

### 前端服务
```bash
cd frontend
npm run dev
```
✅ 前端已启动在：http://localhost:5173

## 🧪 测试步骤

### 1. 登录教务账号
1. 访问 http://localhost:5173
2. 使用教务账号登录：
   - 用户名：`jwc001` (或其他教务账号)
   - 密码：`123456`

### 2. 进入开课管理页面
1. 登录后，在左侧菜单栏找到 **"开课管理"** (日历图标)
2. 点击进入开课管理界面

### 3. 查看现有开课实例
- 页面会自动加载现有的开课实例列表
- 可以按学期筛选
- 列表显示：
  - 实例ID
  - 课程名称和ID
  - 学期
  - 教室
  - 名额（对内/对外）
  - 已选人数
  - 授课教师

### 4. 创建新的开课实例

#### 步骤1：基本信息
1. 点击右上角 **"创建开课实例"** 按钮
2. 填写基本信息：
   - **课程**：从下拉列表选择（例如：数据结构 CS201）
   - **学期**：选择学期（例如：2024-2025 秋季）
   - **教室**：选择教室（显示容量）
   - **对内名额**：设置本院系学生名额（例如：50）
   - **对外名额**：设置跨院系学生名额（例如：20）
3. 系统会自动检查：
   - 如果总名额 > 教室容量，会显示警告
4. 点击 **"下一步"**

#### 步骤2：授课教师
1. 从教师列表中选择一位或多位教师
2. 教师列表显示：姓名、工号、院系
3. 支持多选（Ctrl/Cmd + 点击）
4. 至少选择一位教师
5. 点击 **"下一步"**

#### 步骤3：上课时间
1. 点击 **"添加时间段"** 按钮
2. 为每个时间段填写：
   - **星期**：选择周一至周日
   - **时间段**：选择时间（如 08:00-09:50）
   - **周次**：设置起始周和结束周（1-20）
   - **单双周**：选择全部/单周/双周
   - **授课教师**：为该时间段指定教师（从步骤2选择的教师中选）
3. 可以添加多个时间段（点击删除按钮可移除）
4. 至少添加一个时间段
5. 点击 **"提交"**

#### 提交验证
系统会检查：
- ✅ 是否选择了教师
- ✅ 是否添加了时间段
- ✅ 时间段信息是否完整
- ✅ 是否为每个时间段指定了教师

### 5. 查看创建结果
- 提交成功后会显示成功消息
- 对话框自动关闭
- 列表自动刷新，显示新创建的开课实例

## 📊 测试用例

### 测试用例1：正常创建
**输入**：
```json
{
  "course_id": "CS201",
  "semester_id": 1,
  "classroom_id": 5,
  "quota_inner": 50,
  "quota_outer": 20,
  "teachers": [16, 17],
  "time_slots": [
    {
      "weekday": 1,
      "time_slot": 1,
      "start_week": 1,
      "end_week": 16,
      "week_type": "全部",
      "teacher_id": 16
    },
    {
      "weekday": 3,
      "time_slot": 3,
      "start_week": 1,
      "end_week": 16,
      "week_type": "全部",
      "teacher_id": 17
    }
  ]
}
```
**预期结果**：✅ 创建成功，返回实例ID

### 测试用例2：名额超过教室容量
**输入**：
- 教室容量：80人
- 对内名额：60人
- 对外名额：30人
- 总名额：90人 > 80人

**预期结果**：⚠️ 显示警告，但允许提交（可能某些学生会缺席）

### 测试用例3：多位教师共同授课
**输入**：
- 教师：[张三, 李四, 王五]
- 时间段1：周一1-2节，张三
- 时间段2：周三3-4节，李四
- 时间段3：周五5-6节，王五

**预期结果**：✅ 创建成功，三位教师分别在不同时间段授课

### 测试用例4：单双周设置
**输入**：
- 时间段1：周一1-2节，1-16周，单周
- 时间段2：周一1-2节，1-16周，双周

**预期结果**：✅ 创建成功，同一时间位置单双周交替上课

### 测试用例5：缺少必填信息
**输入**：
- 步骤1：未选择课程
- 步骤2：未选择教师
- 步骤3：未添加时间段

**预期结果**：❌ 显示相应的错误提示，无法提交

## 🔍 API测试

### 使用 Swagger UI 测试
访问：http://localhost:8000/docs

#### 1. GET /api/admin/classrooms
获取教室列表
```bash
curl http://localhost:8000/api/admin/classrooms
```

**响应示例**：
```json
{
  "success": true,
  "code": 200,
  "message": "查询到 10 个教室",
  "data": [
    {
      "classroom_id": 1,
      "building": "主楼",
      "room_number": "301",
      "capacity": 80
    }
  ]
}
```

#### 2. GET /api/admin/semesters
获取学期列表
```bash
curl http://localhost:8000/api/admin/semesters
```

**响应示例**：
```json
{
  "success": true,
  "code": 200,
  "message": "查询到 2 个学期",
  "data": [
    {
      "semester_id": 1,
      "semester_name": "2024-2025 秋季"
    }
  ]
}
```

#### 3. POST /api/admin/instances
创建开课实例
```bash
curl -X POST http://localhost:8000/api/admin/instances \
  -H "Content-Type: application/json" \
  -d '{
    "course_id": "CS201",
    "semester_id": 1,
    "classroom_id": 5,
    "quota_inner": 50,
    "quota_outer": 20,
    "teachers": [16, 17],
    "time_slots": [
      {
        "weekday": 1,
        "time_slot": 1,
        "start_week": 1,
        "end_week": 16,
        "week_type": "全部",
        "teacher_id": 16
      }
    ]
  }'
```

**响应示例**：
```json
{
  "success": true,
  "code": 200,
  "message": "开课实例创建成功",
  "data": {
    "instance_id": 123,
    "teachers_count": 2,
    "timeslots_count": 1
  }
}
```

#### 4. GET /api/admin/instances
获取开课实例列表
```bash
curl http://localhost:8000/api/admin/instances?semester_id=1
```

**响应示例**：
```json
{
  "success": true,
  "code": 200,
  "message": "查询到 5 个开课实例",
  "data": [
    {
      "instance_id": 123,
      "course_id": "CS201",
      "course_name": "数据结构",
      "semester_name": "2024-2025 秋季",
      "building": "主楼",
      "room_number": "301",
      "quota_inner": 50,
      "quota_outer": 20,
      "enrolled_inner": 30,
      "enrolled_outer": 10,
      "teachers": "张三, 李四"
    }
  ]
}
```

## 🐛 常见问题

### 问题1：教室列表为空
**原因**：数据库中没有教室数据  
**解决**：运行 `database/04_insert_data.sql` 插入测试数据

### 问题2：学期列表为空
**原因**：数据库中没有学期数据  
**解决**：在数据库中添加学期数据
```sql
INSERT INTO `学期信息表` (`学期名称`) VALUES ('2024-2025 秋季');
```

### 问题3：创建失败 - 课程不存在
**原因**：选择的课程ID不存在  
**解决**：先在"课程管理"中创建课程

### 问题4：创建失败 - 时间冲突
**原因**：教师或教室在该时间段已有课程  
**解决**：触发器会自动检测，选择其他时间或教师

### 问题5：前端无法连接后端
**原因**：CORS配置或后端未启动  
**解决**：
1. 确认后端在 8000 端口运行
2. 检查 `backend/app/main.py` 的CORS设置
3. 检查 `frontend/src/utils/request.js` 的baseURL

## ✅ 验证清单

- [ ] 后端服务启动正常
- [ ] 前端服务启动正常
- [ ] 教务账号登录成功
- [ ] "开课管理"菜单可见
- [ ] 开课实例列表加载成功
- [ ] 教室列表加载成功
- [ ] 学期列表加载成功
- [ ] 课程列表加载成功
- [ ] 教师列表加载成功
- [ ] 步骤1表单验证正常
- [ ] 步骤2教师选择正常
- [ ] 步骤3时间段添加/删除正常
- [ ] 提交验证正常
- [ ] 创建开课实例成功
- [ ] 列表自动刷新
- [ ] 查看详情功能正常

## 📈 性能测试

### 并发创建测试
使用工具（如 Apache Bench）测试并发创建：
```bash
ab -n 10 -c 2 -p instance.json -T application/json http://localhost:8000/api/admin/instances
```

### 大数据量测试
- 创建 100+ 个开课实例
- 测试列表加载性能
- 测试筛选性能

## 🎯 下一步改进

- [ ] 添加编辑开课实例功能
- [ ] 添加删除开课实例功能
- [ ] 添加复制开课实例功能
- [ ] 添加批量导入功能
- [ ] 添加时间冲突可视化
- [ ] 添加教室使用率统计
- [ ] 添加教师工作量统计
