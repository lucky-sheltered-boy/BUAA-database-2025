# ğŸš€ é«˜æ ¡æ™ºèƒ½æ’è¯¾é€‰è¯¾ç®¡ç†ç³»ç»Ÿ - åç«¯å®ç°è¯´æ˜

## ğŸ“‹ ç›®å½•

1. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒå®ç°](#æ ¸å¿ƒå®ç°)
4. [å·²å®ç°åŠŸèƒ½](#å·²å®ç°åŠŸèƒ½)
5. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
6. [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å‰ç«¯ (æœªå®ç°)                    â”‚
â”‚    React / Vue / åŸç”Ÿ HTML              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP/JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FastAPI åç«¯                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  API è·¯ç”±å±‚ (app/api/)          â”‚   â”‚
â”‚  â”‚  - auth.py     (è®¤è¯ç™»å½•)       â”‚   â”‚
â”‚  â”‚  - students.py (å­¦ç”ŸåŠŸèƒ½)       â”‚   â”‚
â”‚  â”‚  - teachers.py (æ•™å¸ˆåŠŸèƒ½)       â”‚   â”‚
â”‚  â”‚  - statistics.py (ç»Ÿè®¡æŠ¥è¡¨)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ•°æ®è®¿é—®å±‚ (app/dal/)          â”‚   â”‚
â”‚  â”‚  - stored_procedures.py         â”‚   â”‚
â”‚  â”‚  - è°ƒç”¨ 14 ä¸ªå­˜å‚¨è¿‡ç¨‹            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å·¥å…·å±‚ (app/utils/)            â”‚   â”‚
â”‚  â”‚  - security.py  (JWT/å¯†ç )      â”‚   â”‚
â”‚  â”‚  - logger.py    (æ—¥å¿—)          â”‚   â”‚
â”‚  â”‚  - exceptions.py (å¼‚å¸¸)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ PyMySQL + DBUtils
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åä¸ºäº‘ TaurusDB (MySQL 8.0)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  10 å¼ æ•°æ®è¡¨                     â”‚   â”‚
â”‚  â”‚  11 ä¸ªè§¦å‘å™¨ (è‡ªåŠ¨å†²çªæ£€æµ‹)      â”‚   â”‚
â”‚  â”‚  14 ä¸ªå­˜å‚¨è¿‡ç¨‹ (ä¸šåŠ¡é€»è¾‘)        â”‚   â”‚
â”‚  â”‚   3 ä¸ªè§†å›¾ (ç®€åŒ–æŸ¥è¯¢)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ç‰¹ç‚¹

âœ… **åˆ†å±‚æ¶æ„**ï¼šAPI â†’ DAL â†’ å­˜å‚¨è¿‡ç¨‹ â†’ æ•°æ®åº“  
âœ… **è¿æ¥æ± **ï¼šDBUtils ç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œæé«˜æ€§èƒ½  
âœ… **JWT è®¤è¯**ï¼šæ— çŠ¶æ€èº«ä»½éªŒè¯ï¼Œæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²  
âœ… **å­˜å‚¨è¿‡ç¨‹å°è£…**ï¼šä¸šåŠ¡é€»è¾‘åœ¨æ•°æ®åº“å±‚ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§  
âœ… **è§¦å‘å™¨ä¿æŠ¤**ï¼šè‡ªåŠ¨æ£€æµ‹å†²çªï¼Œé˜²æ­¢æ— æ•ˆæ•°æ®  

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/                          # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ main.py                   # â­ FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py                 # é…ç½®ç®¡ç†ï¼ˆè¯»å– .envï¼‰
â”‚   â”œâ”€â”€ database.py               # â­ æ•°æ®åº“è¿æ¥æ± 
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                      # â­ API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ auth.py               # âœ… ç”¨æˆ·ç™»å½•ã€Token åˆ·æ–°
â”‚   â”‚   â”œâ”€â”€ students.py           # âœ… å­¦ç”Ÿé€‰è¯¾ã€é€€è¯¾ã€æŸ¥è¯¾è¡¨
â”‚   â”‚   â”œâ”€â”€ teachers.py           # âœ… æ•™å¸ˆæŸ¥è¯¾è¡¨ã€å­¦ç”Ÿåå•
â”‚   â”‚   â””â”€â”€ statistics.py         # âœ… é€‰è¯¾ç»Ÿè®¡ã€ç³»ç»Ÿæ¦‚è§ˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                   # â­ Pydantic æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ auth.py               # ç™»å½•è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ student.py            # å­¦ç”Ÿç›¸å…³æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ teacher.py            # æ•™å¸ˆç›¸å…³æ¨¡å‹
â”‚   â”‚   â””â”€â”€ common.py             # é€šç”¨å“åº”æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ dal/                      # â­ æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â””â”€â”€ stored_procedures.py # âœ… 14 ä¸ªå­˜å‚¨è¿‡ç¨‹å°è£…
â”‚   â”‚
â”‚   â””â”€â”€ utils/                    # â­ å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ security.py           # âœ… JWT ç”Ÿæˆ/éªŒè¯ã€å¯†ç åŠ å¯†
â”‚       â”œâ”€â”€ logger.py             # âœ… æ—¥å¿—é…ç½®ï¼ˆloguruï¼‰
â”‚       â””â”€â”€ exceptions.py         # âœ… è‡ªå®šä¹‰å¼‚å¸¸
â”‚
â”œâ”€â”€ tests/                        # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ conftest.py               # pytest é…ç½®
â”‚   â”œâ”€â”€ test_auth.py              # è®¤è¯æµ‹è¯•
â”‚   â””â”€â”€ test_enrollment.py        # é€‰è¯¾æµ‹è¯•
â”‚
â”œâ”€â”€ logs/                         # æ—¥å¿—æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ app.log                   # åº”ç”¨æ—¥å¿—
â”‚
â”œâ”€â”€ .env                          # â­ ç¯å¢ƒå˜é‡ï¼ˆæ•°æ®åº“é…ç½®ï¼‰
â”œâ”€â”€ .env.example                  # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ requirements.txt              # â­ Python ä¾èµ–
â”œâ”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
â””â”€â”€ APIä½¿ç”¨æ‰‹å†Œ.md                # â­ API ä½¿ç”¨æ–‡æ¡£
```

---

## ğŸ¯ æ ¸å¿ƒå®ç°

### 1. FastAPI åº”ç”¨ (`app/main.py`)

**åŠŸèƒ½**ï¼š
- âœ… åˆ›å»º FastAPI åº”ç”¨
- âœ… é…ç½® CORS ä¸­é—´ä»¶ï¼ˆå…è®¸è·¨åŸŸï¼‰
- âœ… å…¨å±€å¼‚å¸¸å¤„ç†
- âœ… æ³¨å†Œ 4 ä¸ªè·¯ç”±æ¨¡å—
- âœ… è‡ªå®šä¹‰ OpenAPI schemaï¼ˆæ·»åŠ  Authorize æŒ‰é’®ï¼‰
- âœ… å¥åº·æ£€æŸ¥æ¥å£

**å…³é”®ä»£ç **ï¼š
```python
app = FastAPI(
    title="é«˜æ ¡æ™ºèƒ½æ’è¯¾é€‰è¯¾ç®¡ç†ç³»ç»Ÿ",
    version="1.0.0",
    description="åŸºäº FastAPI + åä¸ºäº‘ TaurusDB"
)

# æ³¨å†Œè·¯ç”±
app.include_router(auth.router, prefix="/api/auth", tags=["è®¤è¯"])
app.include_router(students.router, prefix="/api/students", tags=["å­¦ç”Ÿ"])
app.include_router(teachers.router, prefix="/api/teachers", tags=["æ•™å¸ˆ"])
app.include_router(statistics.router, prefix="/api/statistics", tags=["ç»Ÿè®¡"])
```

---

### 2. æ•°æ®åº“è¿æ¥æ±  (`app/database.py`)

**åŠŸèƒ½**ï¼š
- âœ… ä½¿ç”¨ DBUtils åˆ›å»ºè¿æ¥æ± 
- âœ… æ”¯æŒ PyMySQL è¿æ¥ TaurusDB
- âœ… è‡ªåŠ¨ç®¡ç†è¿æ¥çš„è·å–å’Œé‡Šæ”¾
- âœ… æ”¯æŒ SSL/TLS åŠ å¯†è¿æ¥
- âœ… æä¾›ä¸Šä¸‹æ–‡ç®¡ç†å™¨è‡ªåŠ¨æäº¤/å›æ»š

**å…³é”®ä»£ç **ï¼š
```python
class DatabasePool:
    def __init__(self):
        self._pool = PooledDB(
            creator=pymysql,
            maxconnections=20,  # æœ€å¤§è¿æ¥æ•°
            mincached=5,        # æœ€å°ç¼“å­˜è¿æ¥
            host=settings.DB_HOST,
            port=settings.DB_PORT,
            user=settings.DB_USER,
            password=settings.DB_PASSWORD,
            database=settings.DB_NAME,
            charset='utf8mb4',
            cursorclass=pymysql.cursors.DictCursor  # è¿”å›å­—å…¸
        )
    
    @contextmanager
    def get_cursor(self):
        """è·å–æ¸¸æ ‡ï¼ˆè‡ªåŠ¨æäº¤/å›æ»šï¼‰"""
        conn = self._pool.connection()
        cursor = conn.cursor()
        try:
            yield cursor
            conn.commit()
        except Exception:
            conn.rollback()
            raise
        finally:
            cursor.close()
            conn.close()
```

---

### 3. JWT è®¤è¯ (`app/utils/security.py`)

**åŠŸèƒ½**ï¼š
- âœ… ç”Ÿæˆ JWT access_tokenï¼ˆæœ‰æ•ˆæœŸ 30 åˆ†é’Ÿï¼‰
- âœ… ç”Ÿæˆ JWT refresh_tokenï¼ˆæœ‰æ•ˆæœŸ 7 å¤©ï¼‰
- âœ… éªŒè¯ Token æœ‰æ•ˆæ€§
- âœ… ä» Token ä¸­æå–ç”¨æˆ·ä¿¡æ¯
- âœ… å¯†ç éªŒè¯ï¼ˆæ”¯æŒæµ‹è¯•æ•°æ®æ ¼å¼ + MD5 æ ¼å¼ï¼‰

**å…³é”®ä»£ç **ï¼š
```python
def create_access_token(data: dict) -> str:
    """ç”Ÿæˆè®¿é—®ä»¤ç‰Œ"""
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=30)
    to_encode.update({"exp": expire, "type": "access"})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

def verify_token(token: str) -> dict:
    """éªŒè¯ä»¤ç‰Œ"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except JWTError:
        raise AuthenticationError("æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ")
```

---

### 4. å­˜å‚¨è¿‡ç¨‹å°è£… (`app/dal/stored_procedures.py`)

**åŠŸèƒ½**ï¼š
- âœ… å°è£… 14 ä¸ª MySQL å­˜å‚¨è¿‡ç¨‹
- âœ… Python å‡½æ•°è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
- âœ… å¤„ç†è¾“å‡ºå‚æ•°å’Œè¿”å›ç»“æœ
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†

**å·²å°è£…çš„å­˜å‚¨è¿‡ç¨‹**ï¼š

| å­˜å‚¨è¿‡ç¨‹å | Python å‡½æ•° | åŠŸèƒ½ |
|-----------|-------------|------|
| `sp_student_enroll` | `student_enroll()` | å­¦ç”Ÿé€‰è¯¾ |
| `sp_student_drop` | `student_drop()` | å­¦ç”Ÿé€€è¯¾ |
| `sp_get_student_schedule` | `get_student_schedule()` | æŸ¥è¯¢å­¦ç”Ÿè¯¾è¡¨ |
| `sp_get_available_courses` | `get_available_courses()` | æŸ¥è¯¢å¯é€‰è¯¾ç¨‹ |
| `sp_get_teacher_schedule` | `get_teacher_schedule()` | æŸ¥è¯¢æ•™å¸ˆè¯¾è¡¨ |
| `sp_get_enrolled_students` | `get_enrolled_students()` | æŸ¥è¯¢é€‰è¯¾å­¦ç”Ÿ |
| `sp_enrollment_statistics` | `enrollment_statistics()` | é€‰è¯¾ç»Ÿè®¡ |
| ... | ... | ... |

**å…³é”®ä»£ç **ï¼š
```python
def student_enroll(cursor, student_id: int, instance_id: int) -> str:
    """å­¦ç”Ÿé€‰è¯¾"""
    # è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
    cursor.callproc('sp_student_enroll', (student_id, instance_id, '@msg'))
    
    # è·å–è¾“å‡ºå‚æ•°
    cursor.execute('SELECT @msg')
    result = cursor.fetchone()
    message = result['@msg'] if result else 'æœªçŸ¥é”™è¯¯'
    
    # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
    if 'æˆåŠŸ' not in message:
        raise EnrollmentError(message)
    
    return message
```

---

### 5. API è·¯ç”±å®ç°

#### 5.1 è®¤è¯è·¯ç”± (`app/api/auth.py`)

**å·²å®ç°**ï¼š
- âœ… `POST /api/auth/login` - ç”¨æˆ·ç™»å½•
- âœ… `POST /api/auth/refresh` - åˆ·æ–° Token

**ç™»å½•æµç¨‹**ï¼š
```
1. æ¥æ”¶ç”¨æˆ·åå’Œå¯†ç 
2. æŸ¥è¯¢æ•°æ®åº“éªŒè¯ç”¨æˆ·
3. éªŒè¯å¯†ç ï¼ˆæ”¯æŒæµ‹è¯•æ ¼å¼ + MD5ï¼‰
4. ç”Ÿæˆ JWT Token
5. è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯
```

#### 5.2 å­¦ç”Ÿè·¯ç”± (`app/api/students.py`)

**å·²å®ç°**ï¼š
- âœ… `GET /api/students/{id}/available-courses` - æŸ¥è¯¢å¯é€‰è¯¾ç¨‹
- âœ… `POST /api/students/{id}/enroll` - é€‰è¯¾
- âœ… `POST /api/students/{id}/drop` - é€€è¯¾
- âœ… `GET /api/students/{id}/schedule` - æŸ¥çœ‹è¯¾è¡¨

**é€‰è¯¾æµç¨‹**ï¼š
```
1. éªŒè¯ JWT Token
2. æ£€æŸ¥å­¦ç”Ÿ ID æ˜¯å¦åŒ¹é…
3. è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ sp_student_enroll
4. å­˜å‚¨è¿‡ç¨‹è‡ªåŠ¨æ£€æŸ¥ï¼š
   - é€‰è¯¾æ—¶é—´çª—å£
   - æ—¶é—´å†²çª
   - åé¢é™åˆ¶
   - æ˜¯å¦å·²é€‰
5. è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°å·²é€‰äººæ•°
6. è¿”å›ç»“æœ
```

#### 5.3 æ•™å¸ˆè·¯ç”± (`app/api/teachers.py`)

**å·²å®ç°**ï¼š
- âœ… `GET /api/teachers/{id}/schedule` - æŸ¥çœ‹æˆè¯¾è¯¾è¡¨
- âœ… `GET /api/teachers/{id}/students` - æŸ¥çœ‹å­¦ç”Ÿåå•

#### 5.4 ç»Ÿè®¡è·¯ç”± (`app/api/statistics.py`)

**å·²å®ç°**ï¼š
- âœ… `GET /api/statistics/enrollment` - é€‰è¯¾ç»Ÿè®¡
- âœ… `GET /api/statistics/overview` - ç³»ç»Ÿæ¦‚è§ˆ

---

## âœ… å·²å®ç°åŠŸèƒ½

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | æ¥å£æ•° | è¯´æ˜ |
|---------|------|--------|------|
| ç”¨æˆ·è®¤è¯ | âœ… å®Œæˆ | 2 | ç™»å½•ã€åˆ·æ–° Token |
| å­¦ç”Ÿé€‰è¯¾ | âœ… å®Œæˆ | 4 | æŸ¥è¯¢ã€é€‰è¯¾ã€é€€è¯¾ã€è¯¾è¡¨ |
| æ•™å¸ˆæŸ¥è¯¢ | âœ… å®Œæˆ | 2 | è¯¾è¡¨ã€å­¦ç”Ÿåå• |
| æ•°æ®ç»Ÿè®¡ | âœ… å®Œæˆ | 2 | é€‰è¯¾ç»Ÿè®¡ã€æ¦‚è§ˆ |
| **æ€»è®¡** | **âœ… å®Œæˆ** | **11** | **æ ¸å¿ƒåŠŸèƒ½å·²å®ç°** |

### å¾…å®ç°åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

| åŠŸèƒ½æ¨¡å— | ä¼˜å…ˆçº§ | è¯´æ˜ |
|---------|--------|------|
| é™¢ç³»ç®¡ç† | ä¸­ | å¢åˆ æ”¹æŸ¥é™¢ç³» |
| æ•™å®¤ç®¡ç† | ä¸­ | å¢åˆ æ”¹æŸ¥æ•™å®¤ |
| è¯¾ç¨‹ç®¡ç† | ä¸­ | å¢åˆ æ”¹æŸ¥è¯¾ç¨‹ |
| å­¦æœŸç®¡ç† | ä¸­ | å¢åˆ æ”¹æŸ¥å­¦æœŸ |
| ç”¨æˆ·ç®¡ç† | ä¸­ | å¢åˆ æ”¹æŸ¥ç”¨æˆ· |
| å¼€è¯¾å®ä¾‹ç®¡ç† | é«˜ | åˆ›å»ºã€åˆ†é…æ•™å¸ˆã€æ’è¯¾ |

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1: è°ƒç”¨å­˜å‚¨è¿‡ç¨‹

```python
# app/api/students.py
@router.post("/{student_id}/enroll")
async def enroll_course(
    student_id: int,
    request: EnrollRequest,
    current_user: dict = Depends(get_current_user)
):
    """å­¦ç”Ÿé€‰è¯¾"""
    # 1. éªŒè¯æƒé™
    if current_user['user_id'] != student_id:
        raise PermissionError("æ— æƒæ“ä½œ")
    
    # 2. è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ï¼ˆå¸¦æ­»é”é‡è¯•ï¼‰
    max_retries = 3
    for attempt in range(max_retries):
        try:
            with db_pool.get_cursor() as cursor:
                message = student_enroll(
                    cursor, 
                    student_id, 
                    request.instance_id
                )
                
            logger.info(f"å­¦ç”Ÿ {student_id} é€‰è¯¾æˆåŠŸ: å¼€è¯¾å®ä¾‹ {request.instance_id}")
            
            return ResponseModel(
                success=True,
                message=message,
                data=None
            )
            
        except pymysql.err.OperationalError as e:
            # æ­»é”ï¼Œé‡è¯•
            if "Deadlock" in str(e) and attempt < max_retries - 1:
                continue
            raise
```

### ç¤ºä¾‹ 2: JWT Token éªŒè¯

```python
# app/utils/security.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> dict:
    """ä» Token è·å–å½“å‰ç”¨æˆ·"""
    token = credentials.credentials
    
    try:
        payload = verify_token(token)
        return {
            "user_id": payload.get("user_id"),
            "username": payload.get("username"),
            "role": payload.get("role")
        }
    except AuthenticationError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ",
            headers={"WWW-Authenticate": "Bearer"}
        )
```

### ç¤ºä¾‹ 3: ç»Ÿä¸€å“åº”æ ¼å¼

```python
# app/models/common.py
from pydantic import BaseModel, Field
from typing import Generic, TypeVar, Optional

T = TypeVar('T')

class ResponseModel(BaseModel, Generic[T]):
    """ç»Ÿä¸€å“åº”æ¨¡å‹"""
    success: bool = Field(..., description="æ˜¯å¦æˆåŠŸ")
    code: int = Field(200, description="çŠ¶æ€ç ")
    message: str = Field("", description="æ¶ˆæ¯")
    data: Optional[T] = Field(None, description="æ•°æ®")

# ä½¿ç”¨
return ResponseModel(
    success=True,
    code=200,
    message="ç™»å½•æˆåŠŸ",
    data={"access_token": token, "user_info": user}
)
```

---

## ğŸ”„ æ•°æ®æµç¨‹

### å®Œæ•´çš„é€‰è¯¾æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â”‚ (æœªå®ç°) â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ POST /api/students/16/enroll
     â”‚ Authorization: Bearer <token>
     â”‚ {"instance_id": 1}
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI åç«¯                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. éªŒè¯ JWT Token            â”‚  â”‚
â”‚  â”‚    get_current_user()        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2. æ£€æŸ¥æƒé™                  â”‚  â”‚
â”‚  â”‚    user_id æ˜¯å¦åŒ¹é…?         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3. è°ƒç”¨å­˜å‚¨è¿‡ç¨‹              â”‚  â”‚
â”‚  â”‚    student_enroll()          â”‚  â”‚
â”‚  â”‚    (å¸¦æ­»é”é‡è¯•æœºåˆ¶)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ CALL sp_student_enroll(16, 1, @msg)
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TaurusDB æ•°æ®åº“                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å­˜å‚¨è¿‡ç¨‹ sp_student_enroll   â”‚  â”‚
â”‚  â”‚  1. æ£€æŸ¥é€‰è¯¾æ—¶é—´çª—å£         â”‚  â”‚
â”‚  â”‚  2. æ£€æŸ¥æ˜¯å¦å·²é€‰             â”‚  â”‚
â”‚  â”‚  3. æ£€æŸ¥æ—¶é—´å†²çª             â”‚  â”‚
â”‚  â”‚  4. æ£€æŸ¥åé¢                 â”‚  â”‚
â”‚  â”‚  5. INSERT é€‰è¯¾è®°å½•          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è§¦å‘å™¨ tr_after_enroll       â”‚  â”‚
â”‚  â”‚  - è‡ªåŠ¨æ›´æ–°å·²é€‰äººæ•°          â”‚  â”‚
â”‚  â”‚  - æ£€æŸ¥åé¢çº¦æŸ              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ è¿”å› "é€‰è¯¾æˆåŠŸ"
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI åç«¯                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 4. è®°å½•æ—¥å¿—                  â”‚  â”‚
â”‚  â”‚    logger.info()             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 5. è¿”å›ç»Ÿä¸€æ ¼å¼å“åº”          â”‚  â”‚
â”‚  â”‚    ResponseModel()           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ JSON Response
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯    â”‚
â”‚ (æœªå®ç°) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æŠ€æœ¯äº®ç‚¹

### 1. **åˆ†å±‚æ¶æ„**
- API å±‚åªè´Ÿè´£è·¯ç”±å’Œå‚æ•°éªŒè¯
- DAL å±‚å°è£…æ‰€æœ‰æ•°æ®åº“æ“ä½œ
- ä¸šåŠ¡é€»è¾‘åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ï¼ˆæ•°æ®åº“å±‚ï¼‰

### 2. **è¿æ¥æ± ç®¡ç†**
- ä½¿ç”¨ DBUtils è¿æ¥æ± ï¼Œé¿å…é¢‘ç¹åˆ›å»ºè¿æ¥
- è‡ªåŠ¨ç®¡ç†è¿æ¥çš„è·å–å’Œé‡Šæ”¾
- æé«˜å¹¶å‘æ€§èƒ½

### 3. **JWT æ— çŠ¶æ€è®¤è¯**
- Token åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œæ— éœ€æŸ¥è¯¢æ•°æ®åº“
- æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
- æ”¯æŒ Token åˆ·æ–°æœºåˆ¶

### 4. **å­˜å‚¨è¿‡ç¨‹å°è£…**
- æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨æ•°æ®åº“å±‚
- ä¿è¯æ•°æ®ä¸€è‡´æ€§
- å‡å°‘ç½‘ç»œä¼ è¾“

### 5. **è§¦å‘å™¨ä¿æŠ¤**
- è‡ªåŠ¨æ£€æµ‹æ—¶é—´å†²çª
- è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡æ•°æ®
- é˜²æ­¢æ— æ•ˆæ•°æ®å†™å…¥

### 6. **æ­»é”é‡è¯•æœºåˆ¶**
- é€‰è¯¾é«˜å³°æœŸè‡ªåŠ¨é‡è¯•
- æœ€å¤šé‡è¯• 3 æ¬¡
- ä¿è¯æˆåŠŸç‡

### 7. **ç»Ÿä¸€å“åº”æ ¼å¼**
- æ‰€æœ‰æ¥å£è¿”å›ç›¸åŒæ ¼å¼
- åŒ…å« successã€codeã€messageã€data
- å‰ç«¯æ˜“äºå¤„ç†

### 8. **å®Œå–„çš„æ—¥å¿—**
- loguru æ—¥å¿—åº“
- æŒ‰å¤©è½®è½¬
- è®°å½•æ‰€æœ‰æ“ä½œ

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒè¿è¡Œ

```powershell
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. é…ç½® .env æ–‡ä»¶ï¼ˆæ•°æ®åº“è¿æ¥ï¼‰

# 3. å¯åŠ¨æœåŠ¡
python -m uvicorn app.main:app --reload --port 8000
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# ä½¿ç”¨ Gunicorn + Uvicorn Workers
gunicorn app.main:app \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --bind 0.0.0.0:8000 \
    --access-logfile - \
    --error-logfile -
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹å¼ | æ•ˆæœ |
|-------|---------|------|
| è¿æ¥æ±  | DBUtils | å‡å°‘è¿æ¥å¼€é”€ |
| ç´¢å¼• | æ•°æ®åº“ç´¢å¼• | åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ |
| å­˜å‚¨è¿‡ç¨‹ | MySQL å­˜å‚¨è¿‡ç¨‹ | å‡å°‘ç½‘ç»œä¼ è¾“ |
| å“åº”ç¼“å­˜ | (å¾…å®ç°) | å‡å°‘æ•°æ®åº“æŸ¥è¯¢ |
| é™æµ | (å¾…å®ç°) | é˜²æ­¢è¿‡è½½ |

---

## ğŸ”’ å®‰å…¨æªæ–½

| å®‰å…¨é¡¹ | å®ç°æ–¹å¼ |
|-------|---------|
| å¯†ç åŠ å¯† | bcrypt / MD5 |
| SQL æ³¨å…¥ | å‚æ•°åŒ–æŸ¥è¯¢ |
| è®¤è¯æˆæƒ | JWT Token |
| HTTPS | (ç”Ÿäº§ç¯å¢ƒ) |
| CORS | é…ç½®å…è®¸çš„åŸŸå |
| æ—¥å¿—è„±æ• | ä¸è®°å½•å¯†ç  |

---

**æ€»ç»“**ï¼šåç«¯å·²å®ç°æ ¸å¿ƒåŠŸèƒ½ï¼Œæ¶æ„æ¸…æ™°ï¼Œä»£ç è§„èŒƒï¼Œå¯ä»¥ç›´æ¥ç”¨äºè¯¾ç¨‹æ¼”ç¤ºå’Œç­”è¾©ï¼ğŸ‰
